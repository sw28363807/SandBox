!function(){"use strict";class e{}e.ResidentPrefabPath="prefab/Resident.prefab",e.FoodPrefabPath="prefab/Food.prefab",e.ResdientDetailsPanelPath="prefab/ResidentDetailsPanel.prefab",e.AnimalPrefabPath="prefab/Animal.prefab",e.PetPrefabPath="prefab/Pet.prefab",e.DragRenderPrefabPath="prefab/DragRender.prefab",e.TipPrefabPath="prefab/Tip.prefab",e.CommonItemPrefabPath="prefab/CommonItem.prefab",e.BuildingAtlasPath="res/atlas/source/building.atlas",e.FoodAtlasPath="res/atlas/source/food.atlas",e.ResidentAtlasPath="res/atlas/source/resident.atlas",e.HomePrefabPath="prefab/Home.prefab",e.HospitalPrefabPath="prefab/Hospital.prefab",e.SchoolPrefabPath="prefab/School.prefab",e.ChildSchoolPrefabPath="prefab/ChildSchool.prefab",e.PowerPlantPrefabPath="prefab/PowerPlant.prefab",e.ShopPrefabPath="prefab/Shop.prefab",e.FarmLandPrefabPath="prefab/FarmLand.prefab",e.PasturePrefabPath="prefab/Pasture.prefab",e.OperaPrefabPath="prefab/Opera.prefab",e.OfficePrefabPath="prefab/Office.prefab",e.RestaurantPrefabPath="prefab/Restaurant.prefab",e.PoliceStationPrefabPath="prefab/PoliceStation.prefab",e.LabPrefabPath="prefab/Lab.prefab",e.PetShopPrefabPath="prefab/PetShop.prefab",e.FoodPoolPrefabPath="prefab/FoodPool.prefab",e.WaterPoolPrefabPath="prefab/WaterPool.prefab",e.ResourceMap=[{type:Laya.Loader.ATLAS,url:e.BuildingAtlasPath},{type:Laya.Loader.ATLAS,url:e.FoodAtlasPath},{type:Laya.Loader.ATLAS,url:e.ResidentAtlasPath},{type:Laya.Loader.PREFAB,url:e.ResidentPrefabPath},{type:Laya.Loader.PREFAB,url:e.FoodPrefabPath},{type:Laya.Loader.PREFAB,url:e.ResdientDetailsPanelPath},{type:Laya.Loader.PREFAB,url:e.DragRenderPrefabPath},{type:Laya.Loader.PREFAB,url:e.TipPrefabPath},{type:Laya.Loader.PREFAB,url:e.CommonItemPrefabPath},{type:Laya.Loader.PREFAB,url:e.AnimalPrefabPath},{type:Laya.Loader.PREFAB,url:e.PetPrefabPath},{type:Laya.Loader.PREFAB,url:e.HomePrefabPath},{type:Laya.Loader.PREFAB,url:e.HospitalPrefabPath},{type:Laya.Loader.PREFAB,url:e.HospitalPrefabPath},{type:Laya.Loader.PREFAB,url:e.SchoolPrefabPath},{type:Laya.Loader.PREFAB,url:e.ChildSchoolPrefabPath},{type:Laya.Loader.PREFAB,url:e.PowerPlantPrefabPath},{type:Laya.Loader.PREFAB,url:e.FarmLandPrefabPath},{type:Laya.Loader.PREFAB,url:e.PasturePrefabPath},{type:Laya.Loader.PREFAB,url:e.OperaPrefabPath},{type:Laya.Loader.PREFAB,url:e.OfficePrefabPath},{type:Laya.Loader.PREFAB,url:e.PoliceStationPrefabPath},{type:Laya.Loader.PREFAB,url:e.LabPrefabPath},{type:Laya.Loader.PREFAB,url:e.PetShopPrefabPath},{type:Laya.Loader.PREFAB,url:e.RestaurantPrefabPath},{type:Laya.Loader.PREFAB,url:e.ShopPrefabPath},{type:Laya.Loader.PREFAB,url:e.FoodPoolPrefabPath},{type:Laya.Loader.PREFAB,url:e.WaterPoolPrefabPath}];class t extends Laya.Script{constructor(){super(),this.loadIndex=0,this.prefabs={}}static getInstance(){return t.instance=t.instance||new t}loadAllRes(e){this.loadIndex=0,this._loadRes(e)}_loadRes(t){if(this.loadIndex>=e.ResourceMap.length&&t)return void t.run();let i=e.ResourceMap[this.loadIndex];Laya.loader.create(i.url,Laya.Handler.create(this,function(e){i.type==Laya.Loader.PREFAB&&(this.prefabs[i.url]=e),this.loadIndex++,this._loadRes(t)}))}getPrefabInfo(e){return this.prefabs[e]}}class i{}i.mapWidth=0,i.mapHeight=0,i.mapContainer=null;class s{static getSign(e){return e>0?1:-1}static getSign2(e){return e>0?1:0==e?0:-1}static setMapZOrder(e,t){e.zOrder=t||Math.round(e.y+e.height)}}Number.prototype.zeroPad=Number.prototype.zeroPad||function(e){var t=String(e).length-String(this).length+1;return t>0?new Array(t).join("0")+this:this};class n{static randomPointInRect(e,t,i,s){return{x:e+Math.random()*i,y:t+Math.random()*s}}static randomByArea(e,t,i){let s=n.randomSign(),a=n.randomSign(),r=e+s*Math.random()*i,o=t+a*Math.random()*i;return{x:Math.floor(r),y:Math.floor(o)}}static randomByArea2(e,t,i,s,a,r,o){let h=n.randomByArea(e,t,i);return h.x<r?h.x=r:h.x>s-r&&(h.x=s-r),h.y<o?h.y=o:h.y>a-o&&(h.y=a-o),{x:Math.floor(h.x),y:Math.floor(h.y)}}static randomByArea3(e,t,i,s){let n=i+Math.random()*(s-i),a=360*Math.random(),r=Math.sin(a)*n,o=Math.cos(a)*n;return{x:Math.floor(o+e),y:Math.floor(r+t)}}static randomYes(e){return null==e&&(e=.5),Math.random()>=e}static randomSign(){return Math.random()>=.5?1:-1}static randomNumber(e,t){let i=Math.random();return e+Math.round(i*(t-e))}static randomPointForXWithSign(e,t,i){return{x:e+n.randomSign()*Math.round(Math.random()*i),y:t}}static randomPointForX(e,t,i){return{x:e+Math.round(Math.random()*i),y:t}}static randomSex(){return Math.random()>.5?1:2}static randomACellInArray(e){if(0==e.length)return null;return e[n.randomNumber(0,e.length-1)]}}class a{static obtainBuildingType(){for(const e in a.BuildingType)a.BuildingType[e]=e}static obtainBuildingState(){for(const e in a.BuildingState)a.BuildingState[e]=e}}a.BuildingType={NullTyupe:"",HomeType:"",HospitalType:"",SchoolType:"",PowerPlantType:"",ShopType:"",FarmLandType:"",PastureType:"",OperaType:"",PoliceStationType:"",LabType:"",OfficeType:"",ChildSchoolType:"",RestaurantType:"",PetShopType:"",FoodPoolType:"",WaterPoolType:""},a.obtainBuildingType(),a.BuildingState={NullState:"",PreCreating:"",Creating:"",Noraml:"",Occupy:""},a.obtainBuildingState(),a.BuildingCreatingStep=100,a.HomeResidentMaxNum=3,a.BuildingDatas={[String(a.BuildingType.HomeType)]:{prefab:e.HomePrefabPath,preview:"source/building/building1_1.png",realWidth:200,realHeight:200,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:1,buildingName:"家",costTree:2,costStone:2,desc:"居住的地方"},[String(a.BuildingType.HospitalType)]:{prefab:e.HospitalPrefabPath,preview:"source/building/hospital1_1.png",realWidth:300,realHeight:300,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"医院",costTree:0,costStone:0,desc:"可以治疗疾病"},[String(a.BuildingType.SchoolType)]:{prefab:e.SchoolPrefabPath,preview:"source/building/school_1.png",realWidth:300,realHeight:300,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"学校",costTree:6,costStone:6,addTeach:20,desc:"可以增长教育"},[String(a.BuildingType.ChildSchoolType)]:{prefab:e.ChildSchoolPrefabPath,preview:"source/building/child_school.png",realWidth:200,realHeight:200,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"幼儿园",costTree:0,costStone:0,desc:"可以让孩子快速成长"},[String(a.BuildingType.PowerPlantType)]:{prefab:e.PowerPlantPrefabPath,preview:"source/building/power_plant.png",realWidth:500,realHeight:500,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"发电厂",costTree:6,costStone:6,desc:"可以为其他建筑发电"},[String(a.BuildingType.ShopType)]:{prefab:e.ShopPrefabPath,preview:"source/building/shop_1.png",realWidth:200,realHeight:200,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"商店",costTree:6,costStone:6,desc:"可以购买神秘物品"},[String(a.BuildingType.FarmLandType)]:{prefab:e.FarmLandPrefabPath,preview:"source/building/farmland.png",realWidth:250,realHeight:250,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"农田",costTree:6,costStone:6,desc:"可以种植增加食物"},[String(a.BuildingType.PastureType)]:{prefab:e.PasturePrefabPath,preview:"source/building/pasture.png",realWidth:128,realHeight:128,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"牧场",costTree:6,costStone:6,desc:"可以饲养动物增加食物来源"},[String(a.BuildingType.OperaType)]:{prefab:e.OperaPrefabPath,preview:"source/building/center2.png",realWidth:500,realHeight:500,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"歌剧院",costTree:6,costStone:6,desc:"可以让居民快乐的地方"},[String(a.BuildingType.PoliceStationType)]:{prefab:e.PoliceStationPrefabPath,preview:"source/building/police.png",realWidth:300,realHeight:300,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"警察局",costTree:6,costStone:6,desc:"可以平息冲突"},[String(a.BuildingType.LabType)]:{prefab:e.LabPrefabPath,preview:"source/building/scienceLab.png",realWidth:500,realHeight:500,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"科学实验室",costTree:6,costStone:6,desc:"快速增长科技研究"},[String(a.BuildingType.OfficeType)]:{prefab:e.OfficePrefabPath,preview:"source/building/office.png",realWidth:300,realHeight:300,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"写字楼",costTree:6,costStone:6,desc:"居民收入来源"},[String(a.BuildingType.RestaurantType)]:{prefab:e.RestaurantPrefabPath,preview:"source/building/restaurant.png",realWidth:200,realHeight:200,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"餐厅",costTree:6,costStone:6,desc:"可以囤积食物，增加食物增长值"},[String(a.BuildingType.PetShopType)]:{prefab:e.PetShopPrefabPath,preview:"source/building/pet_shop.png",realWidth:200,realHeight:200,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"宠物店",costTree:0,costStone:0,desc:"饲养宠物可以不减快乐值哦"},[String(a.BuildingType.FoodPoolType)]:{prefab:e.FoodPoolPrefabPath,preview:"source/building/FoodPool.png",realWidth:100,realHeight:100,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"食物仓库",costTree:0,costStone:0,maxSave:300,desc:"可以保存食物以便今后使用"},[String(a.BuildingType.WaterPoolType)]:{prefab:e.WaterPoolPrefabPath,preview:"source/building/WaterPool.png",realWidth:100,realHeight:100,createBuildingSpeed:2e3,useBuildingTime:5e3,createPriority:2,buildingName:"水仓库",costTree:0,costStone:0,maxSave:1e3,desc:"可以保存水源以便今后使用"}};class r{static obtainResidentState(){for(const e in r.ResidentState)r.ResidentState[e]=e}}r.ResidentState={NullState:"",IdleState:"",FindBlockForCreateHome:"",GotoContinueCreateHome:"",CreateHome:"",FindTree:"",CutDownTree:"",FindStone:"",CollectStone:"",FindFood:"",EatFood:"",FindWater:"",DrinkWater:"",LoverMan:"",LoverWoman:"",LoverGoHomeMakeLove:"",LoverMakeLove:"",JoinTalking:"",TalkingAbout:"",JoinHunt:"",Hunting:"",Die:"",GotoContinueCreateHospital:"",CreateHospital:"",GotoTreat:"",Treating:"",GotoContinueCreateSchool:"",CreateSchool:"",GoToSchool:"",Learning:"",GotoContinueCreatePowerPlant:"",CreatePowerPlant:"",GotoContinueCreateShop:"",CreateShop:"",GotoContinueCreateFarmLand:"",CreateFarmLand:"",GotoContinueCreatePasture:"",CreatePasture:"",GotoContinueCreateOpera:"",CreateOpera:"",JoinFight:"",Fighting:"",GotoContinueCreatePoliceStation:"",CreatePoliceStation:"",GotoContinueCreateLab:"",CreateLab:"",GotoContinueCreateOffice:"",CreateOffice:"",RandomWalk:"",GotoContinueCreateChildSchool:"",CreateChildSchool:"",GotoChildSchoolForLearn:"",ChildLearn:"",GotoContinueCreatePetShop:"",CreatePetShop:"",GotoContinueCreateFoodPool:"",CreateFoodPool:"",GotoContinueCreateWaterPool:"",CreateWaterPool:"",FindFoodForSend:"",CollectFood:"",SendFoodToFoodPool:"",FindWaterForSend:"",CollectWater:"",SendWaterToWaterPool:"",GotoFoodPoolForEat:"",EatFoodInFoodPool:"",GotoWaterPoolForDrink:"",DrinkWaterInWaterPool:"",GotoPetShopForTakeOutPet:"",TakeOutPet:""},r.obtainResidentState(),r.ResidentContinueCreateMap={[String(r.ResidentState.GotoContinueCreateHome)]:r.ResidentState.CreateHome,[String(r.ResidentState.GotoContinueCreateHospital)]:r.ResidentState.CreateHospital,[String(r.ResidentState.GotoContinueCreateSchool)]:r.ResidentState.CreateSchool,[String(r.ResidentState.GotoContinueCreatePowerPlant)]:r.ResidentState.CreatePowerPlant,[String(r.ResidentState.GotoContinueCreateShop)]:r.ResidentState.CreateShop,[String(r.ResidentState.GotoContinueCreateFarmLand)]:r.ResidentState.CreateFarmLand,[String(r.ResidentState.GotoContinueCreatePasture)]:r.ResidentState.CreatePasture,[String(r.ResidentState.GotoContinueCreateOpera)]:r.ResidentState.CreateOpera,[String(r.ResidentState.GotoContinueCreatePoliceStation)]:r.ResidentState.CreatePoliceStation,[String(r.ResidentState.GotoContinueCreateLab)]:r.ResidentState.CreateLab,[String(r.ResidentState.GotoContinueCreateOffice)]:r.ResidentState.CreateOffice,[String(r.ResidentState.GotoContinueCreateChildSchool)]:r.ResidentState.CreateChildSchool,[String(r.ResidentState.GotoContinueCreatePetShop)]:r.ResidentState.CreatePetShop,[String(r.ResidentState.GotoContinueCreateFoodPool)]:r.ResidentState.CreateFoodPool,[String(r.ResidentState.GotoContinueCreateWaterPool)]:r.ResidentState.CreateWaterPool},r.ResidentCreateBuildingAIMap={[String(a.BuildingType.HospitalType)]:r.ResidentState.GotoContinueCreateHospital,[String(a.BuildingType.SchoolType)]:r.ResidentState.GotoContinueCreateSchool,[String(a.BuildingType.PowerPlantType)]:r.ResidentState.GotoContinueCreatePowerPlant,[String(a.BuildingType.ShopType)]:r.ResidentState.GotoContinueCreateShop,[String(a.BuildingType.FarmLandType)]:r.ResidentState.GotoContinueCreateFarmLand,[String(a.BuildingType.PastureType)]:r.ResidentState.GotoContinueCreatePasture,[String(a.BuildingType.OperaType)]:r.ResidentState.GotoContinueCreateOpera,[String(a.BuildingType.PoliceStationType)]:r.ResidentState.GotoContinueCreatePoliceStation,[String(a.BuildingType.LabType)]:r.ResidentState.GotoContinueCreateLab,[String(a.BuildingType.OfficeType)]:r.ResidentState.GotoContinueCreateOffice,[String(a.BuildingType.ChildSchoolType)]:r.ResidentState.GotoContinueCreateChildSchool,[String(a.BuildingType.PetShopType)]:r.ResidentState.GotoContinueCreatePetShop,[String(a.BuildingType.FoodPoolType)]:r.ResidentState.GotoContinueCreateFoodPool,[String(a.BuildingType.WaterPoolType)]:r.ResidentState.GotoContinueCreateWaterPool},r.ResidentUseBuildingMap={[String(r.ResidentState.GotoTreat)]:{nextState:r.ResidentState.Treating,buildingType:a.BuildingType.HospitalType},[String(r.ResidentState.GoToSchool)]:{nextState:r.ResidentState.Learning,buildingType:a.BuildingType.SchoolType},[String(r.ResidentState.GoToSGotoChildSchoolForLearnchool)]:{nextState:r.ResidentState.ChildLearn,buildingType:a.BuildingType.ChildSchoolType},[String(r.ResidentState.GotoFoodPoolForEat)]:{nextState:r.ResidentState.EatFoodInFoodPool,buildingType:a.BuildingType.FoodPoolType},[String(r.ResidentState.GotoWaterPoolForDrink)]:{nextState:r.ResidentState.DrinkWaterInWaterPool,buildingType:a.BuildingType.WaterPoolType},[String(r.ResidentState.GotoPetShopForTakeOutPet)]:{nextState:r.ResidentState.TakeOutPet,buildingType:a.BuildingType.PetShopType}},r.ResidentSendAIMap={[String(r.ResidentState.FindFoodForSend)]:{collectState:r.ResidentState.CollectFood,lastState:r.ResidentState.SendFoodToFoodPool,buildingType:a.BuildingType.FoodPoolType},[String(r.ResidentState.FindWaterForSend)]:{collectState:r.ResidentState.CollectWater,lastState:r.ResidentState.SendWaterToWaterPool,buildingType:a.BuildingType.WaterPoolType}},r.ResidentAnim={Null:0,Idle:1,Walk:2,Enjoy:3,Work:4,Die:5,Anger:6},r.CutDownTreeTime=1e4,r.CollectStoneTime=1e4,r.ResidentMoveSpeed=4,r.SocialTimeStep=1e3,r.SocialFightStep=1e3,r.DieTime=2e3,r.MakeLoveMaxDeltay=1e4,r.ResidentNumPerHome=3,r.ResidentValueStep=1e3,r.ResidentMakeIdeaStep=1e3,r.ResidentReduceWaterBaseValue=-.3,r.ResidentReduceFoodBaseValue=-.25,r.ResidentReduceSocialBaseValue=-.4,r.ResidentAddSocialBaseValue=60,r.ResidentReduceLifeBaseValue=-.5,r.ResidentReduceEnjoyBaseValue=-.25,r.ResidentSickProbability=.999,r.ResidentTreatTime=1e4,r.ResidentLearnTime=5e3,r.ResidentLearnTimeForChildLearn=1e4,r.ResidentSocialLowToFight=70,r.ResidentSocialNeedValue=30,r.ResidentWaterNeedValue=20,r.ResidentFoodNeedValue=20,r.ResidentEnjoyNeedValue=30,r.ResidentSocialArea=2e3,r.ResidentFightArea=500,r.ResidentFightNum=10,r.ResidentAddTreeBaseValue=1,r.ResidentAddStoneBaseValue=1,r.ResidentFindPathTimes=5,r.ResidentAdultAge=5,r.ResidentMarryAge=r.ResidentAdultAge+2,r.ResidentAgePeriod=5e4,r.ResidentGotoYOff=10,r.ResidentChildSchoolSearchArea=1e3,r.ResidentCollectSendTime=2e3,r.ResidentDrinkWaterAddValue=50,r.ResidentSaveWaterAddValue=100;class o extends Laya.Script{constructor(){super(),this.movePaths=[],this.curDest=null,this.finishHandler=null}setCallbackFunc(e){this.leftFunc=e.leftFunc,this.rightFunc=e.rightFunc,this.upFunc=e.upFunc,this.downFunc=e.downFunc}onStart(){}onDestroy(){this.stopGoto()}refreshDirectCallback(){this.curDest&&(this.curDest.x?this.curDest.direct>0?this.rightFunc&&this.rightFunc():this.leftFunc&&this.leftFunc():this.curDest.direct>0?this.downFunc&&this.downFunc():this.upFunc&&this.upFunc())}startGoto(){if(!this.curDest){if(0==this.movePaths.length&&this.finishHandler)return void this.finishHandler.run();this.curDest=this.movePaths[0],this.refreshDirectCallback(),this.lastFrameTime=Laya.Browser.now(),Laya.timer.frameLoop(1,this,this._onFrameUpdate)}}stopGoto(){this.movePaths=[],this.curDest=null,this.lastFrameTime=0,Laya.timer.clear(this,this._onFrameUpdate)}gotoDest(e,t){this.finishHandler=t,e.speed?this.speed=e.speed:this.speed=r.ResidentMoveSpeed;let i=Math.round(e.x),a=Math.round(e.y),o=i-Math.round(this.owner.x),h=a-Math.round(this.owner.y);0==o&&0==h&&this.finishHandler&&this.finishHandler.run();let d=s.getSign2(o),l=s.getSign2(h);if(e.forceFirstY||n.randomYes()&&(null==e.forceFirstY||null==e.forceFirstY)){let t={y:a,direct:l},s={x:i,direct:d};0!=l&&this.movePaths.push(t),0!=d&&this.movePaths.push(s),e.isFirstY=!0}else{let t={x:i,direct:d},s={y:a,direct:l};0!=d&&this.movePaths.push(t),0!=l&&this.movePaths.push(s),e.isFirstY=!1}this.startGoto()}_onFrameUpdate(){let e=Laya.Browser.now()-this.lastFrameTime;this._onTick(e),this.lastFrameTime=Laya.Browser.now()}_onTick(e){this.curDest.x?s.getSign2(this.curDest.x-this.owner.x)==this.curDest.direct?this.owner.x+=this.curDest.direct*this.speed*e/30:(this.owner.x=this.curDest.x,this.movePaths.splice(0,1),0!=this.movePaths.length?(this.curDest=this.movePaths[0],this.refreshDirectCallback()):(this.finishHandler&&this.finishHandler.run(),this.stopGoto())):s.getSign2(this.curDest.y-this.owner.y)==this.curDest.direct?this.owner.y+=this.curDest.direct*this.speed*e/30:(this.owner.y=this.curDest.y,this.movePaths.splice(0,1),0!=this.movePaths.length?(this.curDest=this.movePaths[0],this.refreshDirectCallback()):(this.finishHandler&&this.finishHandler.run(),this.stopGoto()))}}class h{}h.MapSideOff=0,h.GameTimeStep=500,h.Seasons=["#c8eea0","#8ef325","#e2f324","#e7e8d4"];class d{}d.AnimalMaxNumPerTrigger=1,d.AnimalTriggerArea=50,d.AnimalUpdateTime=9e4,d.AnimalZOrder=99,d.AnimalMoveSpeed=50,d.AnimalLife=100,d.AnimalHurtTime=1e4,d.AnimalState={NullState:0,Idle:1,Hurt:2,Walk:3,Die:4};class l extends Laya.Script{constructor(){super(),this.animalId=0,this.x=0,this.y=0,this.attackMaxNum=2,this.curAttackNum=0,this.life=d.AnimalLife,this.state=d.AnimalState.NullState,this.huntResidentIds=new Set([])}addHuntResidentIds(e){this.huntResidentIds.add(e)}getHuntResidentIds(){return this.huntResidentIds}clearHuntResidentIds(){this.huntResidentIds.clear()}updateData(e){e&&(e.x&&(this.x=e.x),e.y&&(this.y=e.y),e.animalId&&(this.animalId=e.animalId))}setAttackNum(e){this.curAttackNum=e,this.curAttackNum>this.attackMaxNum?this.curAttackNum=this.attackMaxNum:this.curAttackNum<0&&(this.curAttackNum=0)}getAttackNum(){return this.curAttackNum}addAttackNum(e){this.setAttackNum(this.getAttackNum()+e)}getAttackMaxNum(){return this.attackMaxNum}getX(){return this.x}getY(){return this.y}getAnimalId(){return this.animalId}setState(e){this.state=e}getState(){return this.state}}class u extends Laya.Script{constructor(){super(),this.buildingId=0,this.x=0,this.y=0,this.buildingType=a.BuildingType.NullTyupe,this.buildingState=a.BuildingState.NullState,this.sendEventResidentIds=new Set([]),this.exteraData={}}setExteraData(e,t){this.exteraData[e]=t}getExteraData(e){return this.exteraData[e]}addResidentId(e){this.sendEventResidentIds.add(e)}getResidentIds(){return this.sendEventResidentIds}clearResidentIds(){this.sendEventResidentIds.clear()}getBuildingType(){return this.buildingType}getBuildingId(){return this.buildingId}setBuildingState(e){this.buildingState=e}getBuildingState(){return this.buildingState}getX(){return this.x}getY(){return this.y}updateData(e){e&&(e.x&&(this.x=e.x),e.y&&(this.y=e.y),e.buildingId&&(this.buildingId=e.buildingId),e.buildingType&&(this.buildingType=e.buildingType),e.buildingState&&(this.buildingState=e.buildingState))}}class g extends Laya.Script{constructor(){super(),this.x=0,this.y=0,this.area=0,this.fightPointId=0,this.fightNum=0,this.fightMaxNum=0}getFightPointId(){return this.fightPointId}getFightPosInArea(){return n.randomByArea(this.x,this.y,this.area)}getX(){return this.x}getY(){return this.y}addFightNum(e){this.setFightNum(this.getFightNum()+e)}setFightNum(e){this.fightNum=e}getFightNum(){return this.fightNum}getFightMaxNum(){return this.fightMaxNum}updateData(e){e&&(e.x&&(this.x=e.x),e.y&&(this.y=e.y),e.area&&(this.area=e.area),e.fightPointId&&(this.fightPointId=e.fightPointId),e.fightMaxNum&&(this.fightMaxNum=e.fightMaxNum))}}class c{static obtainFoodState(){for(const e in c.FoodState)c.FoodState[e]=e}}c.FoodMaxNumPerTrigger=2,c.FoodUpdateTime=4e4,c.FoodZOrder=99,c.DrinkWaterTime=5e3,c.FoodTypes={NullType:0,FruitType:1,MeatType:2},c.FoodAddValue={[c.FoodTypes.FruitType]:{deltayTime:5e3,addValue:30},[c.FoodTypes.MeatType]:{deltayTime:5e3,addValue:30}},c.FoodState={CanEat:"",Occupy:"",Eating:""},c.obtainFoodState();class S extends Laya.Script{constructor(){super(),this.food=0,this.foodId=0,this.x,this.y,this.foodType=c.FoodTypes.NullType,this.state=c.FoodState.CanEat,this.eatFinishTime=0}getFoodType(){return this.foodType}setFoodType(e){this.foodType=e}getFoodId(){return this.foodId}getX(){return this.x}getY(){return this.y}getFoodState(){return this.state}setFoodState(e){this.state=e}getFood(){return this.food}getEatCDTime(){return c.FoodAddValue[this.foodType].deltayTime}updateData(e){e&&(e.food&&(this.food=e.food),e.x&&(this.x=e.x),e.y&&(this.y=e.y),e.foodId&&(this.foodId=e.foodId),e.foodType&&(this.foodType=e.foodType,this.food=c.FoodAddValue[this.foodType].addValue))}}class m{constructor(){this.eventDispatcher=new Laya.EventDispatcher}static getInstance(){return m.instance?m.instance:m.instance=new m}postEvent(e,t){this.eventDispatcher.event(e,t)}registEvent(e,t,i,s){this.removeEvent(e,t,i),this.eventDispatcher.on(e,t,i,s)}removeEvent(e,t,i){this.eventDispatcher.off(e,t,i,!1)}removeEventAll(e){this.eventDispatcher.offAll(e)}offAllCaller(e){this.eventDispatcher.offAllCaller(e)}removeAllEvent(){this.eventDispatcher.offAll(eventName)}}class p{static getSystemTime(){let e=new Date,t=e.getTimezoneOffset();return e.getTime()+60*t*1e3}}class y{}y.CREATE_BUILDING_FINISH="CREATE_BUILDING_FINISH",y.HUNT_FINISH="HUNT_FINISH",y.RESIDENT_SICK="RESIDENT_SICK",y.RESIDENT_DIE="RESIDENT_DIE",y.RESIDENT_GROWUP="RESIDENT_GROWUP";class f{static randomOneName(){let e=Math.random(),t=Math.floor(e*f.FirstName.length),i=Math.floor(e*f.LastName.length);return f.FirstName[t]+f.LastName[i]}}f.FirstName=["孙","沈","李","王","赵","司马","诸葛","周"],f.LastName=["文","建蕊","二狗","狗胜","桂芬","翠萍","秀姑","大壮","Joel","Season","Jack","大壮","钢弹","见章"];class R extends Laya.Script{constructor(){super(),this.life=100,this.water=100,this.enjoy=100,this.food=100,this.teach=0,this.social=100,this.positive=.6,this.myHomeId=0,this.isInChildSchool=!1,this.ageExp=0,this.makeLoveSystemTime=0,this.petType=0,this.temperature=36,this.age=1,this.sex=1,this.married=1,this.sick=1,this.residentName=f.randomOneName(),this.x=0,this.y=0,this.residentId=0,this.curFSMState=r.ResidentState.NullState}updateData(e){e&&(e.life&&(this.life=e.life),e.water&&(this.water=e.water),e.enjoy&&(this.enjoy=e.enjoy),e.food&&(this.food=e.food),e.teach&&(this.teach=e.teach),e.social&&(this.social=e.social),e.myHomeId&&(this.myHomeId=e.myHomeId),e.temperature&&(this.temperature=e.temperature),e.age&&(this.age=e.age),e.sex&&(this.sex=e.sex),e.married&&(this.married=e.married),e.residentName&&(this.residentName=e.residentName),e.x&&(this.x=e.x),e.y&&(this.y=e.y),e.residentId&&(this.residentId=e.residentId),e.curFSMState&&(this.curFSMState=e.curFSMState),e.sick&&(this.sick=e.sick),e.positive&&(this.positive=e.positive),e.ageExp&&(this.ageExp=e.ageExp),e.petType&&(this.petType=e.petType))}setPetType(e){this.petType=e}getPetType(){return this.petType}recordMakeLoveSystemTime(){0==this.makeLoveSystemTime&&(this.makeLoveSystemTime=p.getSystemTime())}getMakeLoveSystemTime(){return this.makeLoveSystemTime}addAgeExp(e,t){if(this.setAgeExp(this.getAgeExp()+e),this.ageExp>=r.ResidentAgePeriod){let e=this.age,i=this.ageExp%r.ResidentAgePeriod;if(this.addAge(Math.floor(this.ageExp/r.ResidentAgePeriod)),this.ageExp=i,e<r.ResidentAdultAge&&this.age>=r.ResidentAdultAge)return t&&m.getInstance().postEvent(y.RESIDENT_GROWUP,this),!0}return!1}setAgeExp(e){this.ageExp=e}getAgeExp(){return this.ageExp}getSick(){return this.sick}setSick(e){this.sick=e}setLoverId(e){this.loverId=e}getLoverId(){return this.loverId}getResidentId(){return this.residentId}getFSMState(){return this.curFSMState}setFSMState(e){this.curFSMState=e}getMarried(){return this.married}setMarried(e){this.married=e}setAge(e){this.age=e}getAge(){return this.age}addAge(e){this.setAge(this.getAge()+e)}setMyHomeId(e){this.myHomeId=e}getMyHomeId(){return this.myHomeId}onStep(){p.getSystemTime()>=this.getMakeLoveSystemTime()+r.MakeLoveMaxDeltay&&(this.makeLoveSystemTime=0),this.addAgeExp(r.ResidentMakeIdeaStep,!0),this.getLife()<=0&&this.getFSMState()==r.ResidentState.IdleState?m.getInstance().postEvent(y.RESIDENT_DIE,this):(this.addEnjoy(r.ResidentReduceEnjoyBaseValue),this.addSocial(r.ResidentReduceSocialBaseValue),this.addWater(r.ResidentReduceWaterBaseValue),this.addFood(r.ResidentReduceFoodBaseValue),1==this.getSick()&&Math.random()>r.ResidentSickProbability&&(this.setSick(2),m.getInstance().postEvent(y.RESIDENT_SICK,this)),(this.food<=0||this.water<=0||2==this.getSick())&&(2==this.getSick()?this.addLife(1.5*r.ResidentReduceLifeBaseValue):this.addLife(r.ResidentReduceLifeBaseValue)))}canAskMarry(){return 0==this.getMakeLoveSystemTime()&&this.getAge()>=r.ResidentMarryAge&&1==this.getSex()&&0!=this.getMyHomeId()&&this.getSocial()>=20&&this.getFSMState()==r.ResidentState.IdleState}canMarry(e){return 2==this.getSex()&&0==this.getMakeLoveSystemTime()&&this.getAge()>r.ResidentMarryAge&&this.getFSMState()==r.ResidentState.IdleState}addEnjoy(e){this.setEnjoy(this.getEnjoy()+e)}setEnjoy(e){this.enjoy=e,this.enjoy<0?this.enjoy=0:this.enjoy>100&&(this.enjoy=100)}getEnjoy(){return this.enjoy}addSocial(e){this.setSocial(this.getSocial()+e)}setSocial(e){this.social=e,this.social<0?this.social=0:this.social>100&&(this.social=100)}getSocial(){return this.social}getTeach(){return this.teach}addTeach(e){this.setTeach(this.getTeach()+e)}setTeach(e){this.teach=e,this.teach<0?this.teach=0:this.teach>100&&(this.teach=100)}getLife(){return this.life}addLife(e){this.setLife(this.getLife()+e)}setLife(e){this.life=e,this.life<0?this.life=0:this.life>100&&(this.life=100)}getFood(){return this.food}addFood(e){this.setFood(this.getFood()+e)}setFood(e){this.food=e,this.food<0?this.food=0:this.food>100&&(this.food=100)}addWater(e){this.setWater(this.getWater()+e)}setWater(e){this.water=e,this.water<0?this.water=0:this.water>100&&(this.water=100)}getPositive(){return this.positive}getWater(){return this.water}addWater(e){this.setWater(this.getWater()+e)}getSex(){return this.sex}getX(){return this.x}getY(){return this.y}}class T extends Laya.Script{constructor(){super(),this.x=0,this.y=0,this.area=0,this.talkingPointId=0,this.talkingNum=0,this.talkingMaxNum=0}getTalkingPointId(){return this.talkingPointId}getTalkingPosInArea(){return n.randomByArea(this.x,this.y,this.area)}getX(){return this.x}getY(){return this.y}addTalkingNum(e){this.setTalkingNum(this.getTalkingNum()+e)}setTalkingNum(e){this.talkingNum=e}getTalkingNum(){return this.talkingNum}getTalkingMaxNum(){return this.talkingMaxNum}updateData(e){e&&(e.x&&(this.x=e.x),e.y&&(this.y=e.y),e.area&&(this.area=e.area),e.talkingPointId&&(this.talkingPointId=e.talkingPointId),e.talkingMaxNum&&(this.talkingMaxNum=e.talkingMaxNum))}}class P extends Laya.Script{constructor(){super(),this.maxResidentID=0,this.maxFoodID=0,this.maxBuildingID=0,this.maxTalkingID=0,this.maxFightID=0,this.maxAnimalID=0,this.residentModels={},this.foodModels={},this.buildingModels={},this.talkingPoints={},this.fightPoints={},this.animalModes={},this.treeNum=0,this.stoneNum=0,this.gameYear=0,this.gameDay=0,this.gameSeason=0,this.gameHour=0}onEnable(){}onDisable(){}static getInstance(){return P.instance?P.instance:(P.instance=new P,P.instance.initSelf(),P.instance)}getAllChildResidentNum(){let e=0;for(let t in this.residentModels){this.residentModels[t].getAge()<r.ResidentAdultAge&&e++}return e}getHomeNum(){let e=0;for(const t in this.buildingModels){this.buildingModels[t].getBuildingType()==a.BuildingType.HomeType&&e++}return e}getAllResidentNum(){return Object.keys(this.residentModels).length}getGameSeason(){return this.gameSeason}getGameDay(){return this.gameDay}getGameHour(){return this.gameHour}getTreeNum(){return this.treeNum}setTreeNum(e){this.treeNum=e,this.treeNum<0&&(this.treeNum=0)}addTreeNum(e){this.setTreeNum(this.getTreeNum()+e)}setStoneNum(e){this.stoneNum=e,this.stoneNum<0&&(this.stoneNum=0)}getStoneNum(){return this.stoneNum}addStoneNum(e){this.setStoneNum(this.getStoneNum()+e)}newAnimalModel(e){this.maxAnimalID++;let t=new l;return t.updateData({x:e.x,y:e.y,animalId:this.maxAnimalID}),this.animalModes[String(this.maxAnimalID)]=t,t}removeAnimalModel(e){this.animalModes[String(e)]}getBuildingModel(e){return this.buildingModels[String(e)]}getOrCreateTalkingPoint(e,t,i,s){for(const i in this.talkingPoints){let s=this.talkingPoints[i],n=new Laya.Point(e,t).distance(s.getX(),s.getY());if(s.getTalkingNum()<s.getTalkingMaxNum()&&n<=r.ResidentSocialArea)return s}return this.newTalkingPoint(e,t,i,s)}removeTalkingPoint(e){this.talkingPoints[String(e)].destroy(!0),delete this.talkingPoints[String(e)]}newTalkingPoint(e,t,i,s){this.maxTalkingID++;let n=new T;return n.updateData({x:e,y:t,area:i,talkingPointId:this.maxTalkingID,talkingMaxNum:s}),this.talkingPoints[String(this.maxTalkingID)]=n,n}getOrCreateFightPoint(e,t,i,s){for(const i in this.fightPoints){let s=this.fightPoints[i],n=new Laya.Point(e,t).distance(s.getX(),s.getY());if(s.getFightNum()<s.getFightMaxNum()&&n<=r.ResidentFightArea)return s}return this.newFightPoint(e,t,i,s)}removeFightPoint(e){this.fightPoints[String(e)].destroy(!0),delete this.fightPoints[String(e)]}newFightPoint(e,t,i,s){this.maxFightID++;let n=new g;return n.updateData({x:e,y:t,area:i,fightPointId:this.maxFightID,fightMaxNum:s}),this.fightPoints[String(this.maxFightID)]=n,n}newBuildingModel(e){this.maxBuildingID++;let t=new u;return t.updateData({x:e.x,y:e.y,buildingId:this.maxBuildingID,buildingType:e.buildingType,buildingState:a.BuildingState.PreCreating}),this.buildingModels[String(this.maxBuildingID)]=t,t}newFoodModel(e){this.maxFoodID++;let t=new S;return t.updateData({x:e.x,y:e.y,foodId:this.maxFoodID,foodType:e.foodType}),this.foodModels[String(this.maxFoodID)]=t,t}removeFoodModelById(e){delete this.foodModels[String(e)]}randomSex(){let e=this.getAllChildResidentNum();return e<6?e%2==0?1:2:n.randomSex()}setMarried(e,t){e.setMarried(2),t.setMarried(2),e.setLoverId(t.getResidentId()),t.setLoverId(e.getResidentId()),t.setMyHomeId(e.getMyHomeId())}newResidentModel(e){this.maxResidentID++;let t=new R;return e.residentId=this.maxResidentID,t.updateData(e),this.residentModels[String(this.maxResidentID)]=t,t}removeResientModel(e){delete this.residentModels[String(e)]}removeBuildingModel(e){delete this.buildingModels[String(e)]}onUpdateResidentValue(){for(let e in this.residentModels){this.residentModels[e].onStep()}}onGameTimeStep(){this.gameHour+=1,this.gameHour>=24&&(this.gameDay+=1,this.gameHour=0),this.gameDay>=30&&(this.gameDay=0,this.gameSeason+=1),this.gameSeason>=4&&(this.gameYear+=1,this.gameSeason=0)}initSelf(){Laya.timer.loop(r.ResidentValueStep,this,this.onUpdateResidentValue),Laya.timer.loop(h.GameTimeStep,this,this.onGameTimeStep)}}class F extends Laya.Script{constructor(){super()}onEnable(){this.ani=this.owner.getChildByName("ani"),this.sliderControl=this.owner.getChildByName("sliderControl"),this.slider=this.sliderControl.getChildByName("slider"),this.sliderControl.visible=!1,this.sliderMax=194}onDisable(){}onDestroy(){this.stopTimer()}stopTimer(){Laya.timer.clear(this,this.onCreateProgress)}refreshByModel(e){this.model=e,this.owner.x=e.getX(),this.owner.y=e.getY();let t=this.model.getBuildingType(),i=a.BuildingDatas[String(t)];this.createAddValue=i.createBuildingSpeed/this.sliderMax,this.onInitBuilding(),this.setPreCreate()}setPreCreate(){this.ani.play(0,!0,"precreate"),this.sliderControl.visible=!0,this.slider.width=1}joinResidentIdToBuilding(e){this.model.addResidentId(e)}startCreate(){this.model.getBuildingState()==a.BuildingState.PreCreating&&(this.model.setBuildingState(a.BuildingState.Creating),this.ani.play(0,!0,"creating"),this.sliderControl.visible=!0,this.slider.width=1,Laya.timer.loop(a.BuildingCreatingStep,this,this.onCreateProgress))}onCreateProgress(){this.slider.width=this.slider.width+this.createAddValue,this.slider.width>this.sliderMax&&(this.slider.width=this.sliderMax,this.stopTimer(),this.onCreateFinish())}onCreateFinish(){this.ani.play(0,!0,"idle"),this.sliderControl.visible=!1,Laya.timer.clear(this,this.onCreateProgress),this.model.setBuildingState(a.BuildingState.Noraml),s.setMapZOrder(this.owner),this.onCreateBuildingFinish(),m.getInstance().postEvent(y.CREATE_BUILDING_FINISH,this.makeParam(this.model)),this.model.clearResidentIds()}makeParam(e){let t={};return t.residentIds=this.model.getResidentIds(),t.extraParam=e,t}getModel(){return this.model}onInitBuilding(){}onCreateBuildingFinish(){}}class b extends Laya.Script{constructor(){super(),this.buildings={}}static getInstance(){return b.instance=b.instance||new b}onEnable(){}onDisable(){}getBuildingById(e){return this.buildings[String(e)]}getBuildings(){return this.buildings}createBuildingByConfig(e){let t=P.getInstance().newBuildingModel(e),i=Laya.loader.getRes(e.prefab).create();e.parent.addChild(i);let s=i.getComponent(F);return i.buildingScript=s,s.refreshByModel(t),this.buildings[String(t.getBuildingId())]=i,i}removeBuildingById(e){let t=this.buildings[String(e)];t&&(delete this.buildings[String(e)],t.destroy(!0),P.getInstance().removeBuildingModel(e))}canCreateBuildingForResource(e){let t=P.getInstance().getTreeNum(),i=P.getInstance().getStoneNum(),s=a.BuildingDatas[String(e)];return t>=s.costTree&&i>=s.costStone}intersectsBuilding(e,t,i,s){let n=new Laya.Rectangle(e,t,i,s);for(let e in this.buildings){let t=this.buildings[e];if(n.intersects(new Laya.Rectangle(t.x,t.y,t.width,t.height)))return!0}return!1}getNearstBuilding(e,t,i,s,n){let a=new Set(n),r=null,o=99999999;for(const n in this.buildings){let h=this.buildings[n],d=new Laya.Point(h.x,h.y).distance(e,t),l=h.buildingScript.getModel();d<=s&&a.has(l.getBuildingState())&&l.getBuildingType()==i&&(o=d,r=h)}return r}getAlltBuildingForCondition(e,t,i,s,n){let a=new Set(n),r=[];for(const n in this.buildings){let o=this.buildings[n],h=new Laya.Point(o.x,o.y).distance(e,t),d=o.buildingScript.getModel();h<=s&&a.has(d.getBuildingState())&&d.getBuildingType()==i&&r.push(o)}return r}}class L extends Laya.Script{constructor(){super()}onEnable(){}onDisable(){}refreshInfo(e){this.owner.getChildByName("name").text=e.residentName;let t="男";2==e.sex&&(t="女"),this.owner.getChildByName("sex").text="性别: "+t;let i="未婚";2==e.married&&(i="已婚"),this.owner.getChildByName("married").text=i,this.owner.getChildByName("temperature").text="体温: "+String(e.temperature),this.owner.getChildByName("age").text="年龄: "+String(e.age),this.setSlider("sliderLife",e.life),this.setSlider("sliderWater",e.water),this.setSlider("sliderFood",e.food),this.setSlider("sliderEnjoy",e.enjoy),this.setSlider("sliderTeach",e.teach),this.setSlider("sliderSocial",e.social)}setSlider(e,t){let i=this.owner.getChildByName(e).getChildByName("slider"),s=t/100,n=Math.ceil(194*s)/194;i.scaleY=n}}class w extends Laya.Script{constructor(){super(),this.curPanel=null}onEnable(){}onDisable(){}static getInstance(){return w.instance=w.instance||new w}showPanel(t){this.removePanel();let i=Laya.loader.getRes(e.ResdientDetailsPanelPath);this.curPanel=i.create(),this.curPanel.x=65,this.curPanel.y=15-this.curPanel.height,t.parent.addChild(this.curPanel),this.curPanel.getComponent(L).refreshInfo(t.data),this.curPanel.alpha=0,Laya.Tween.to(this.curPanel,{alpha:1},200),Laya.timer.once(3e3,this,this.fadeOutFunc)}fadeOutFunc(){Laya.Tween.to(this.curPanel,{alpha:0},200,null,Laya.Handler.create(this,function(){this.removePanel()}))}removePanel(){this.curPanel&&(Laya.timer.clear(this,this.fadeOutFunc),this.curPanel.removeSelf(),this.curPanel.destroy(!0),this.curPanel=null)}}class I extends Laya.Script{constructor(){super(),this.treeID=0}onEnable(){this.ani=this.owner.getChildByName("ani"),s.setMapZOrder(this.owner)}onDisable(){}onStart(){this.ani.play(0,!0,"idle1")}setTreeID(e){this.treeID=e}}class B extends Laya.Script{constructor(){super(),this.trees={},this.maxID=0}static getInstance(){return B.instance=B.instance||new B}pushTree(e){this.maxID++;let t=e.getComponent(I);t&&t.setTreeID(this.maxID),this.trees[String(this.maxID)]=e}intersectsTree(e,t,i,s){let n=new Laya.Rectangle(e,t,i,s);for(let e in this.trees){let t=this.trees[e];if(n.intersects(new Laya.Rectangle(t.x,t.y,t.width,t.height)))return!0}return!1}getNearstTree(e,t){let i=99999999,s=null;for(let n in this.trees){let a=this.trees[n],r=new Laya.Point(a.x,a.y).distance(e,t);r<i&&(i=r,s=a)}return s}onEnable(){}onDisable(){}}class C extends Laya.Script{constructor(){super(),this.stoneID=0}onEnable(){this.ani=this.owner.getChildByName("ani"),s.setMapZOrder(this.owner)}onDisable(){}onStart(){this.ani.play(0,!0,"idle1")}setStoneID(e){this.stoneID=e}}class A extends Laya.Script{constructor(){super(),this.stones={},this.maxID=0}static getInstance(){return A.instance=A.instance||new A}pushStone(e){this.maxID++;let t=e.getComponent(C);t&&t.setStoneID(this.maxID),this.stones[String(this.maxID)]=e}getNearstStone(e,t){let i=99999999,s=null;for(let n in this.stones){let a=this.stones[n],r=new Laya.Point(a.x,a.y).distance(e,t);r<i&&(i=r,s=a)}return s}intersectsStone(e,t,i,s){let n=new Laya.Rectangle(e,t,i,s);for(let e in this.stones){let t=this.stones[e];if(n.intersects(new Laya.Rectangle(t.x,t.y,t.width,t.height)))return!0}return!1}onEnable(){}onDisable(){}}class x extends Laya.Script{constructor(){super()}onEnable(){this.ani=this.owner.getChildByName("ani"),this.owner.zOrder=c.FoodZOrder,this.trigger=null}onDisable(){}onStart(){Laya.timer.once(1e3,this,this.fadeOutFinish),this.ani.play(0,!1,"fadeOut"+String(this.foodAnimIndex))}fadeOutFinish(){this.ani.play(0,!0,"idle"+String(this.foodAnimIndex)),Laya.timer.clear(this,this.fadeOutFinish)}onDestroy(){Laya.timer.clear(this,this.fadeOutFinish),this.trigger&&this.trigger.addNum(-1)}setTrigger(e){this.trigger=e}getTrigger(){return this.trigger}refreshByModel(e){this.model=e,this.owner.x=e.getX(),this.owner.y=e.getY(),this.foodType=this.model.getFoodType(),this.foodType==c.FoodTypes.FruitType?this.foodAnimIndex=Math.ceil(5*Math.random()):this.foodAnimIndex=6}getModel(){return this.model}}class M extends Laya.Script{constructor(){super(),this.foods={}}static getInstance(){return M.instance=M.instance||new M}createFoodByConfig(t){let i=Laya.loader.getRes(e.FoodPrefabPath).create();t.parent.addChild(i);let s=i.getComponent(x);i.foodScript=s,s.setTrigger(t.trigger);let n=P.getInstance().newFoodModel(t);return s.refreshByModel(n),this.foods[String(n.getFoodId())]=i,i}getNearstFood(e){let t=99999999,i=null;for(const s in this.foods){let n=this.foods[s];if(null!=e.state&&n.foodScript.getModel().getFoodState()!=e.state)continue;let a=new Laya.Point(n.x,n.y).distance(e.x,e.y);a<=e.area&&a<t&&(t=a,i=n)}return i}canFindFood(){for(const e in this.foods){if(this.foods[e].foodScript.getModel().getFoodState()==c.FoodState.CanEat)return!0}return!1}getFoodById(e){return this.foods[String(e)]}removeFoodById(e){for(const t in this.foods){let i=this.foods[t];if(i.foodScript.getModel().getFoodId()==e)return i.destroy(!0),delete this.foods[t],void P.getInstance().removeFoodModelById(e)}}}class N extends Laya.Script{constructor(){super(),this.waterID=0}setWaterID(e){this.waterID=e}onEnable(){s.setMapZOrder(this.owner,-i.mapHeight)}onDisable(){}onStart(){}}class k extends Laya.Script{constructor(){super(),this.maxID=0,this.waters={}}static getInstance(){return k.instance=k.instance||new k}pushWater(e){this.maxID++;let t=e.getComponent(N);t&&t.setWaterID(this.maxID),this.waters[String(this.maxID)]=e}randomWater(e,t,i){let s=[];for(let n in this.waters){let a=this.waters[n];new Laya.Point(a.x,a.y).distance(e,t)<i&&s.push(a)}return n.randomACellInArray(s)}intersectsWater(e,t,i,s){let n=new Laya.Rectangle(e,t,i,s);for(let e in this.waters){let t=this.waters[e];if(n.intersects(new Laya.Rectangle(t.x,t.y,t.width,t.height)))return!0}return!1}onEnable(){}onDisable(){}}class D extends Laya.Script{constructor(){super()}onDestroy(){this.trigger&&this.trigger.addNum(-1),M.getInstance().createFoodByConfig({parent:i.mapContainer,x:this.owner.x+this.owner.width/2,y:this.owner.y+this.owner.height/2,foodType:c.FoodTypes.MeatType})}onEnable(){this.trigger=null,this.root=this.owner.getChildByName("root"),this.ani=this.root.getChildByName("ani")}onDisable(){Laya.timer.clear(this,this.onWalkFinish),Laya.timer.clear(this,this.onHurtFinish)}onStart(){this.owner.alpha=0,Laya.Tween.to(this.owner,{alpha:1},1e3,Laya.Ease.circIn),this.setIdle(),this.setWalk()}joinHunt(e){this.model.addHuntResidentIds(e)}setIdle(){this.model.getState()!=d.AnimalState.Idle&&(this.tweenObject&&(Laya.Tween.clear(this.tweenObject),this.tweenObject=null),this.model.setState(d.AnimalState.Idle),this.ani.play(0,!0,"idle1"))}setWalk(){this.onWalkFinish(),Laya.timer.loop(3e3,this,this.onWalkFinish)}pauseWalk(){this.setIdle(),Laya.timer.clear(this,this.onWalkFinish)}setHurt(){this.model.getState()!=d.AnimalState.Hurt&&(Laya.timer.once(d.AnimalHurtTime,this,this.onHurtFinish),Laya.timer.clear(this,this.onWalkFinish),this.tweenObject&&(Laya.Tween.clear(this.tweenObject),this.tweenObject=null),this.model.setState(d.AnimalState.Hurt),this.ani.play(0,!0,"hurt1"))}makeParam(e){let t={};return t.residentIds=this.model.getHuntResidentIds(),t.extraParam=e,t}onHurtFinish(){Laya.timer.clear(this,this.onHurtFinish),m.getInstance().postEvent(y.HUNT_FINISH,this.makeParam(this.owner)),this.model.clearHuntResidentIds()}onWalkFinish(){if(this.model.getState()==d.AnimalState.Walk)return;this.model.setState(d.AnimalState.Walk),this.ani.play(0,!0,"walk1");let e=n.randomByArea(this.trigger.owner.x,this.trigger.owner.y,150);this.gotoDest({x:e.x,y:e.y},Laya.Handler.create(this,function(){this.setIdle()}))}setTrigger(e){this.trigger=e}getTrigger(){return this.trigger}refreshByModel(e){this.model=e,this.owner.x=e.getX(),this.owner.y=e.getY()}getModel(){return this.model}gotoDest(e,t){this.tweenObject&&(Laya.Tween.clear(this.tweenObject),this.tweenObject=null);let i=e.x,n=e.y,a=s.getSign(i-this.owner.x);this.root.scaleX=a*Math.abs(this.root.scaleX);let r=new Laya.Point(i,n).distance(this.owner.x,this.owner.y)/d.AnimalMoveSpeed;this.tweenObject=Laya.Tween.to(this.owner,{x:i,y:n},1e3*r,null,t)}}class v extends Laya.Script{constructor(){super(),this.animals={}}onEnable(){}onDisable(){Laya.timer.clear(this,this.onUpdateFunc)}static getInstance(){return v.instance?v.instance:(v.instance=new v,v.instance.initSelf(),v.instance)}initSelf(){Laya.timer.loop(1e3,this,this.onUpdateFunc)}onUpdateFunc(){for(let e in this.animals){let t=this.animals[e];s.setMapZOrder(t)}}removeAnimalById(e){let t=this.animals[String(e)];t&&(t.destroy(!0),delete this.animals[String(e)],P.getInstance().removeAnimalModel(e))}createAnimalByConfig(t){let i=Laya.loader.getRes(e.AnimalPrefabPath).create();t.parent.addChild(i);let s=i.getComponent(D);s.setTrigger(t.trigger);let n=P.getInstance().newAnimalModel(t);s.refreshByModel(n),this.animals[String(n.getAnimalId())]=i}getAnimalForAttack(e,t,i){for(const s in this.animals){let n=this.animals[s],a=n.getComponent(D).getModel();if(new Laya.Point(n.x,n.y).distance(e,t)<=i&&a.getAttackNum()<a.getAttackMaxNum()&&a.getState()!=d.AnimalState.Die)return n}return null}}class E{static randomOneBoredTip(){let e=Math.random(),t=Math.floor(e*E.BoredTips.length);return E.BoredTips[t]}}E.BoredTipsProbability=.9,E.BoredTips=["不想努力了","好开心","我想吃软饭","我想喝啤酒","太无聊了","快去谈恋爱","光棍一个"];class H extends Laya.Script{constructor(){super()}onEnable(){this.curNum=0}onDisable(){Laya.timer.clear(this,this.onCreateFood)}onStart(){Laya.timer.loop(c.FoodUpdateTime,this,this.onCreateFood),this.onCreateFood()}onCreateFood(){if(this.curNum>=c.FoodMaxNumPerTrigger)return;let e=this.owner.x+n.randomNumber(0,this.owner.width),t=this.owner.y+this.owner.height-n.randomNumber(50,this.owner.height);M.getInstance().createFoodByConfig({parent:i.mapContainer,x:e,y:t,trigger:this,foodType:c.FoodTypes.FruitType}),this.addNum(1)}addNum(e){this.curNum=this.curNum+e,this.curNum>=c.FoodMaxNumPerTrigger&&(this.curNum=c.FoodMaxNumPerTrigger)}}class W extends Laya.Script{constructor(){super(),this.triggers={}}static getInstance(){return W.instance=W.instance||new W}pushFoodTrigger(e){e.getComponent(H)&&""!=e.foodTriggerKey&&(this.triggers[e.foodTriggerKey]=e)}intersectsFoodTrigger(e,t,i,s){let n=new Laya.Rectangle(e,t,i,s);for(let e in this.triggers){let t=this.triggers[e];if(n.intersects(new Laya.Rectangle(t.x,t.y,t.width,t.height)))return!0}return!1}onEnable(){}onDisable(){}}class O{static isOccupySpace(e,t,i,s){return!!B.getInstance().intersectsTree(e,t,i,s)||(!!A.getInstance().intersectsStone(e,t,i,s)||(!!b.getInstance().intersectsBuilding(e,t,i,s)||(!!k.getInstance().intersectsWater(e,t,i,s)||!!W.getInstance().intersectsFoodTrigger(e,t,i,s))))}static getAIGoToCreateBuildingInfo(e,t){let i=b.getInstance().getBuildings(),s=new Set([a.BuildingState.PreCreating,a.BuildingState.Creating]),o=new Set([]);for(const e in r.ResidentCreateBuildingAIMap)o.add(e);let h=[];for(const n in i){let a=i[n],d=new Laya.Point(a.x,a.y).distance(e,t),l=a.buildingScript.getModel(),u=l.getBuildingType();d<=1e3&&s.has(l.getBuildingState())&&o.has(u)&&h.push({building:a,state:r.ResidentCreateBuildingAIMap[u]})}return 0==h.length?null:h[n.randomNumber(0,h.length-1)]}}class G extends Laya.Script{constructor(){super()}onEnable(){}onDisable(){}}class j extends Laya.Script{constructor(){super()}onEnable(){this.ani=this.owner.getChildByName("ani")}onDisable(){}onStart(){this.moveLogic=this.owner.getComponent(o),this.initMoveLogic(),this.ani.play(0,!0,"idle")}initMoveLogic(){let e=this;this.leftFunc=function(){e.ani.play(0,!0,"walk_left")},this.rightFunc=function(){e.ani.play(0,!0,"walk_right")},this.upFunc=function(){e.ani.play(0,!0,"walk_up")},this.downFunc=function(){e.ani.play(0,!0,"walk_down")},this.moveLogic.setCallbackFunc({leftFunc:this.leftFunc,rightFunc:this.rightFunc,upFunc:this.upFunc,downFunc:this.downFunc})}walkTo(e,t){this.moveLogic.gotoDest(e,Laya.Handler.create(this,function(){this.ani.play(0,!0,"idle"),t&&t.run()}))}}class U extends Laya.Script{constructor(){super()}onStart(){this.initMoveLogic()}onEnable(){this.rigsterAllEvents(),this.initModel(),this.initControl(),this.initTouch(),this.residentTempData=new G,this.movePaths=[]}onDisable(){}onDestroy(){this.ResidentTempData.destroy(!0),this.removeAllEvents(),this.removeAllTimers()}initMoveLogic(){let e=this;this.leftFunc=function(){e.ani.play(0,!0,"walk_left")},this.rightFunc=function(){e.ani.play(0,!0,"walk_right")},this.upFunc=function(){e.ani.play(0,!0,"walk_up")},this.downFunc=function(){e.ani.play(0,!0,"walk_down")},this.getMoveScript().setCallbackFunc({leftFunc:this.leftFunc,rightFunc:this.rightFunc,upFunc:this.upFunc,downFunc:this.downFunc})}removeAllTimers(){Laya.timer.clear(this,this.onDoWorkFinish),Laya.timer.clear(this,this.hideTip),Laya.timer.clear(this,this.onCollectSendFinish),Laya.timer.clear(this,this.onPutDownSend)}rigsterAllEvents(){m.getInstance().registEvent(y.RESIDENT_SICK,this,this.onSick),m.getInstance().registEvent(y.RESIDENT_DIE,this,this.onDie),m.getInstance().registEvent(y.RESIDENT_GROWUP,this,this.onGrowUp)}removeAllEvents(){m.getInstance().removeEvent(y.RESIDENT_SICK,this,this.onSick),m.getInstance().removeEvent(y.RESIDENT_DIE,this,this.onDie),m.getInstance().removeEvent(y.RESIDENT_GROWUP,this,this.onGrowUp)}initControl(){this.initAnim(),this.stateAni=this.owner.getChildByName("stateAni"),this.buffAni=this.owner.getChildByName("buff"),this.tipSpr=this.owner.getChildByName("tipSpr"),this.boredTip=this.tipSpr.getChildByName("text"),this.hideTip(),this.setStateAniVisible(!1),this.setBuffAniVisible(!1)}initAnim(){this.manAni=this.owner.getChildByName("manAni"),this.womanAni=this.owner.getChildByName("womanAni"),this.babyAni=this.owner.getChildByName("babyAni"),this.manAni.stop(),this.womanAni.stop(),this.babyAni.stop(),this.manAni.visible=!1,this.womanAni.visible=!1,this.babyAni.visible=!1}onGrowUp(e){this.model.getResidentId()==e.getResidentId()&&this.growup()}onDie(e){this.model.getResidentId()==e.getResidentId()&&this.refreshFSMState(r.ResidentState.Die)}onSick(e){if(this.model.getResidentId()!=e.getResidentId())return;2==e.getSick()?(this.setBuffAni("sickAni"),this.setBuffAniVisible(!0)):(this.stopBuffAni(),this.setBuffAniVisible(!1))}hideTip(){this.tipTweenObject&&(Laya.Tween.clear(this.tipTweenObject),this.tipTweenObject=null),Laya.timer.clear(this,this.hideTip),this.tipSpr.scaleX=0,this.tipSpr.scaleY=0,this.tipSpr.visible=!1,this.boredTip.text=""}showTip(e,t){null!=t&&null!=t||(t=!1),this.tipTweenObject&&0==t||(this.hideTip(),this.boredTip.text=e,this.tipSpr.visible=!0,this.tipTweenObject=Laya.Tween.to(this.tipSpr,{scaleX:1,scaleY:1},200,Laya.Ease.backIn,Laya.Handler.create(this,function(){})),Laya.timer.once(3e3,this,this.hideTip))}setBuffAni(e){this.buffAni.play(0,!0,e)}setBuffAniVisible(e){this.buffAni.visible=e}stopBuffAni(){this.buffAni.stop()}setStateAni(e){this.stateAni.play(0,!0,e)}setStateAniVisible(e){this.stateAni.visible=e}stopStateAni(){this.stateAni.stop()}initModel(){this.findCreateHomeTimes=0,this.curStateAnim=r.ResidentAnim.Null}initTouch(){this.owner.on(Laya.Event.CLICK,this,function(){w.getInstance().showPanel({data:this.model,parent:this.owner})})}setResidentMgrInstance(e){this.residentMgrInstance=e}refreshByModel(e){this.model=e,this.owner.x=this.model.getX(),this.owner.y=this.model.getY(),this.model.getAge()<r.ResidentAdultAge?(this.ani=this.babyAni,1==this.model.getSex()?(this.womanAni.destroy(!0),this.womanAni=null):(this.manAni.destroy(!0),this.manAni=null)):1==this.model.getSex()?(this.ani=this.manAni,this.womanAni.destroy(!0),this.womanAni=null):(this.ani=this.womanAni,this.manAni.destroy(!0),this.manAni=null),this.ani.visible=!0,this.refreshFSMState(r.ResidentState.IdleState)}getModel(){return this.model}growup(){let e=this.curStateAnim,t=this.curStateAnimLoop,i=this.ani.visible;this.curStateAnim="",this.babyAni.destroy(!0),this.babyAni=null,1==this.model.getSex()?this.ani=this.manAni:2==this.model.getSex()&&(this.ani=this.womanAni),this.ani.visible=i,this.setAnim(e,t)}setAnim(e,t,i){this.curStateAnim!=e&&(null!=t&&null!=t||(t=!0),e==r.ResidentAnim.Idle?this.ani.play(0,t,"idle"):e==r.ResidentAnim.Walk||(e==r.ResidentAnim.Enjoy?this.ani.play(0,t,"enjoy"):e==r.ResidentAnim.Work?this.ani.play(0,t,"work"):e==r.ResidentAnim.Die?this.ani.play(0,t,"die"):e==r.ResidentAnim.Anger&&("right"==i?this.ani.play(0,t,"anger_right"):this.ani.play(0,t,"anger_left"))),this.curStateAnim=e,this.curStateAnimLoop=t)}stopAni(){this.curStateAnim=null,this.ani.stop()}setVisible(e){this.owner.visible=e}getMoveScript(){return this.owner.residentMoveLogicScript}refreshFSMState(e,t){let i=this.model.getFSMState();if(i==e)return;if(i==r.ResidentState.Die)return;this.model.setFSMState(e),this.setStateAniVisible(!1),this.setVisible(!0),this.stopStateAni(),this.stopAni(),this.getMoveScript().stopGoto(),Laya.timer.clear(this,this.onDoWorkFinish);let s=this.canGotoCreateBuilding(e),a=this.canGotoUseBuilding(e),o=this.canSendExt(e),h=this.canCollect(e),d=this.canSendToDest(e);if(s)this.startGotoContinueCreateBuilding({building:t,nextState:s});else if(a)this.startGotoBuildingForUse({building:t,nextState:a.nextState});else if(this.canStartCreateBuilding(e))this.startCreateBuilding();else if(this.canStartUseBuilding(e))this.startUseBuilding();else if(o)this.gotoFindSend({sendAIMeta:o,sendInfo:t});else if(h)this.colletSend(t);else if(d)this.gotoSendToDest(t);else if(e==r.ResidentState.IdleState)this.setAnim(r.ResidentAnim.Idle);else if(e==r.ResidentState.FindBlockForCreateHome)this.setAnim(r.ResidentAnim.Walk),this.startFindCreateHomeBlock();else if(e==r.ResidentState.FindTree)this.setAnim(r.ResidentAnim.Walk),this.startFindANearstTree();else if(e==r.ResidentState.CutDownTree)this.setAnim(r.ResidentAnim.Work),this.setStateAniVisible(!0),this.setStateAni("ani1"),Laya.timer.once(r.CutDownTreeTime,this,this.onDoWorkFinish,[this.makeParam(null)]);else if(e==r.ResidentState.FindStone)this.setAnim(r.ResidentAnim.Walk),this.startFindANearstStone();else if(e==r.ResidentState.CollectStone)this.setStateAniVisible(!0),this.setStateAni("ani2"),this.setAnim(r.ResidentAnim.Work),Laya.timer.once(r.CollectStoneTime,this,this.onDoWorkFinish,[this.makeParam(null)]);else if(e==r.ResidentState.FindFood)this.setAnim(r.ResidentAnim.Walk),this.startFindANearstFood();else if(e==r.ResidentState.EatFood){this.curEatingFood=t;let e=this.curEatingFood.foodScript.getModel();e.setFoodState(c.FoodState.Eating),this.setStateAniVisible(!0),this.setAnim(r.ResidentAnim.Work),this.setStateAni("ani3"),Laya.timer.once(e.getEatCDTime(),this,this.onDoWorkFinish,[this.makeParam(null)])}else if(e==r.ResidentState.FindWater)this.setAnim(r.ResidentAnim.Walk),this.startFindANearstWater();else if(e==r.ResidentState.DrinkWater)this.setAnim(r.ResidentAnim.Work),this.setStateAniVisible(!0),this.setStateAni("ani4"),Laya.timer.once(c.DrinkWaterTime,this,this.onDoWorkFinish,[this.makeParam(null)]);else if(e==r.ResidentState.LoverMan)this.setAnim(r.ResidentAnim.Walk),this.setStateAniVisible(!0),this.setStateAni("ani5"),this.startFindWoman();else if(e==r.ResidentState.LoverWoman)this.setAnim(r.ResidentAnim.Idle),this.setStateAniVisible(!0),this.setStateAni("ani5");else if(e==r.ResidentState.LoverGoHomeMakeLove)this.setAnim(r.ResidentAnim.Walk),this.setStateAniVisible(!0),this.setStateAni("ani5"),this.startGoHomeAndWoman();else if(e==r.ResidentState.LoverMakeLove)this.setVisible(!1),this.startMakelove();else if(e==r.ResidentState.JoinTalking)this.setAnim(r.ResidentAnim.Walk),this.startJoinTalkingPoint(t);else if(e==r.ResidentState.TalkingAbout)this.setAnim(r.ResidentAnim.Enjoy),this.setStateAniVisible(!0),this.setStateAni("ani6"),Laya.timer.once(10*r.SocialTimeStep,this,this.onDoWorkFinish,[this.makeParam(t)]);else if(e==r.ResidentState.JoinFight)this.setAnim(r.ResidentAnim.Walk),this.startJoinFightPoint(t);else if(e==r.ResidentState.Fighting)this.setAnim(r.ResidentAnim.Anger,null,n.randomYes()?"left":"right"),this.setStateAniVisible(!0),this.setStateAni("ani8"),Laya.timer.once(10*r.SocialFightStep,this,this.onDoWorkFinish,[this.makeParam(t)]);else if(e==r.ResidentState.JoinHunt){this.hurtAnimal=t;let e=this.hurtAnimal.getComponent(D);this.hurtAnimalId=e.getModel().getAnimalId(),this.setAnim(r.ResidentAnim.Walk),this.startJoinHunt()}else if(e==r.ResidentState.Hunting){if(this.hurtAnimal){this.hurtAnimal.getComponent(D).setHurt(),this.setStateAniVisible(!0),this.setStateAni("ani7"),this.setAnim(r.ResidentAnim.Work)}}else e==r.ResidentState.Die?(this.setBuffAniVisible(!1),this.setStateAniVisible(!1),this.setAnim(r.ResidentAnim.Die,!1),Laya.timer.once(r.DieTime,this,this.onDoWorkFinish,[this.makeParam(null)])):e==r.ResidentState.RandomWalk&&this.startGotoRandomPoint(t)}doWorkFinishClearFunc(){Laya.timer.clear(this,this.onDoWorkFinish),this.refreshFSMState(r.ResidentState.IdleState)}onDoWorkFinish(e){if(!e.residentIds.has(this.model.getResidentId()))return;let t=this.model.getFSMState();if(this.canFinishCreateBuilding(t))this.clearContinueCreateBuilding();else if(this.canFinishUseBuilding(t))this.onFinishUseBuilding(t),this.clearUseBuilding();else if(this.canSendFinish(t))this.onFinishSend(e);else if(t==r.ResidentState.EatFood){let e=this.curEatingFood.foodScript.getModel();this.model.addFood(e.getFood()),M.getInstance().removeFoodById(e.getFoodId()),this.curEatingFood=null}else if(t==r.ResidentState.DrinkWater)this.model.addWater(r.ResidentDrinkWaterAddValue);else if(t==r.ResidentState.CutDownTree)P.getInstance().addTreeNum(r.ResidentAddTreeBaseValue);else if(t==r.ResidentState.CollectStone)P.getInstance().addStoneNum(r.ResidentAddStoneBaseValue);else if(t==r.ResidentState.TalkingAbout){let t=e.extraParam;t.addTalkingNum(-1),this.model.addSocial(r.ResidentAddSocialBaseValue),0==t.getTalkingNum()&&P.getInstance().removeTalkingPoint(t.getTalkingPointId())}else if(t==r.ResidentState.Fighting){let t=e.extraParam;t.addFightNum(-1),this.model.addLife(-100),0==t.getFightNum()&&P.getInstance().removeFightPoint(t.getFightPointId())}else if(t==r.ResidentState.JoinHunt)this.hurtAnimal&&(m.getInstance().removeEvent(y.HUNT_FINISH,this,this.onDoWorkFinish),v.getInstance().removeAnimalById(this.hurtAnimalId),this.hurtAnimal=null,this.hurtAnimalId=null);else if(t==r.ResidentState.Hunting)this.hurtAnimal&&(m.getInstance().removeEvent(y.HUNT_FINISH,this,this.onDoWorkFinish),v.getInstance().removeAnimalById(this.hurtAnimalId),this.hurtAnimal=null,this.hurtAnimalId=null);else{if(t==r.ResidentState.Die)return b.getInstance().removeBuildingById(this.model.getMyHomeId()),void this.residentMgrInstance.removeResidentById(this.model.getResidentId());t==r.ResidentState.CreateHome&&this.clearContinueCreateBuilding()}this.doWorkFinishClearFunc()}startGotoRandomPoint(e){this.walkTo({x:e.x,y:e.y},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.IdleState)}))}onUseBuildingCondition(e){return e==r.ResidentState.GotoTreat?2==this.model.getSick()&&(this.useBuildingAIPriority=1,!0):e==r.ResidentState.GoToSchool?this.model.getTeach()<100:e==r.ResidentState.GotoChildSchoolForLearn?this.model.getAge()<r.ResidentAdultAge:e==r.ResidentState.GotoFoodPoolForEat?this.model.getFood()<90:e==r.ResidentState.GotoWaterPoolForDrink?this.model.getWater()<90:e==r.ResidentState.GotoPetShopForTakeOutPet?0==this.model.getPetType():void 0}onGetBuilding(e,t){if(e==r.ResidentState.GotoTreat){return b.getInstance().getNearstBuilding(this.owner.x,this.owner.y,t.buildingType,2e3,[a.BuildingState.Noraml])}if(e==r.ResidentState.GoToSchool){return b.getInstance().getNearstBuilding(this.owner.x,this.owner.y,t.buildingType,2e3,[a.BuildingState.Noraml])}if(e==r.ResidentState.GotoChildSchoolForLearn){return b.getInstance().getNearstBuilding(this.owner.x,this.owner.y,t.buildingType,2e3,[a.BuildingState.Noraml])}if(e==r.ResidentState.GotoFoodPoolForEat){let e=b.getInstance().getAlltBuildingForCondition(this.owner.x,this.owner.y,t.buildingType,2e3,[a.BuildingState.Noraml]);if(0!=e.length)for(const t in e){let i=e[t];if(i.buildingScript.getCurSaveFood()>0)return i}return null}if(e==r.ResidentState.GotoWaterPoolForDrink){let e=b.getInstance().getAlltBuildingForCondition(this.owner.x,this.owner.y,t.buildingType,2e3,[a.BuildingState.Noraml]);if(0!=e.length)for(const t in e){let i=e[t];if(i.buildingScript.getCurSaveWater()>0)return i}return null}if(e==r.ResidentState.GotoPetShopForTakeOutPet){let e=b.getInstance().getAlltBuildingForCondition(this.owner.x,this.owner.y,t.buildingType,2e3,[a.BuildingState.Noraml]);if(0!=e.length)for(const t in e){let i=e[t];if(i.buildingScript.getFirstPetInPetList()>0)return i.buildingScript.getModel().setBuildingState(a.BuildingState.Occupy),i}return null}}onFinishUseBuilding(e){if(e==r.ResidentState.Treating)this.model.setSick(1),this.setBuffAniVisible(!1),this.stopBuffAni();else if(e==r.ResidentState.Learning)this.model.addTeach(a.BuildingDatas[String(a.BuildingType.SchoolType)].addTeach);else if(e==r.ResidentState.ChildLearn)this.model.addAgeExp(Math.round(r.ResidentAgePeriod/2),!0);else if(e==r.ResidentState.EatFoodInFoodPool){let e=this.model.getFood(),t=this.useBuilding.buildingScript.getCurSaveFood(),i=Math.round(100-e),s=0;(s=i>=t?t:i)>40&&(s=40),this.useBuilding.buildingScript.addFoodToPool(-s),this.model.addFood(s)}else if(e==r.ResidentState.DrinkWaterInWaterPool){let e=this.model.getWater(),t=this.useBuilding.buildingScript.getCurSaveWater(),i=Math.round(100-e),s=0;(s=i>=t?t:i)>40&&(s=40),this.useBuilding.buildingScript.addWaterToPool(-s),this.model.addWater(s)}else if(e==r.ResidentState.TakeOutPet){let e=this.useBuilding.buildingScript.popFirstPet();this.model.setPetType(e),this.addPetByPetType(e),this.useBuilding.buildingScript.getModel().setBuildingState(a.BuildingState.Noraml)}}canGotoUseBuilding(e){return r.ResidentUseBuildingMap[String(e)]}startGotoBuildingForUse(e){this.setAnim(r.ResidentAnim.Walk),this.useBuilding=e.building;let t=e.nextState;this.walkTo({x:this.useBuilding.x+this.useBuilding.width/2-this.owner.width/2,y:this.useBuilding.y+this.useBuilding.height-this.owner.height+r.ResidentGotoYOff},Laya.Handler.create(this,function(){this.refreshFSMState(t,this.useBuilding)}))}canStartUseBuilding(e){for(const t in r.ResidentUseBuildingMap){if(r.ResidentUseBuildingMap[t].nextState==e&&null!=e&&null!=e)return!0}return!1}canFinishUseBuilding(e){for(const t in r.ResidentUseBuildingMap){if(r.ResidentUseBuildingMap[t].nextState==e&&null!=e&&null!=e)return!0}return!1}startUseBuilding(){if(this.useBuilding){this.stopAni(),this.owner.visible=!1;let e=this.useBuilding.buildingScript.getModel().getBuildingType(),t=a.BuildingDatas[String(e)];Laya.timer.once(t.useBuildingTime,this,this.onDoWorkFinish,[this.makeParam(null)])}}clearUseBuilding(){Laya.timer.clear(this,this.onDoWorkFinish),this.useBuilding=null}canGotoCreateBuilding(e){return r.ResidentContinueCreateMap[String(e)]}canStartCreateBuilding(e){for(const t in r.ResidentContinueCreateMap){if(r.ResidentContinueCreateMap[t]==e&&null!=e&&null!=e)return!0}return!1}canFinishCreateBuilding(e){for(const t in r.ResidentContinueCreateMap){if(r.ResidentContinueCreateMap[t]==e&&null!=e&&null!=e)return!0;if(Number(t)==e&&null!=e&&null!=e)return!0}return!1}startGotoContinueCreateBuilding(e){m.getInstance().registEvent(y.CREATE_BUILDING_FINISH,this,this.onDoWorkFinish),this.setAnim(r.ResidentAnim.Walk),this.continueCreateBuilding=e.building;let t=e.nextState;this.continueCreateBuilding.buildingScript.joinResidentIdToBuilding(this.model.getResidentId()),this.walkTo({x:this.continueCreateBuilding.x+this.continueCreateBuilding.width/2-this.owner.width/2,y:this.continueCreateBuilding.y+this.continueCreateBuilding.height-this.owner.height+r.ResidentGotoYOff},Laya.Handler.create(this,function(){this.refreshFSMState(t,this.continueCreateBuilding)}))}startCreateBuilding(){this.continueCreateBuilding&&(this.setAnim(r.ResidentAnim.Work),this.setStateAniVisible(!0),this.setStateAni("ani2"),this.continueCreateBuilding.buildingScript.startCreate())}clearContinueCreateBuilding(){m.getInstance().removeEvent(y.CREATE_BUILDING_FINISH,this,this.onDoWorkFinish),this.continueCreateBuilding=null}startJoinHunt(){m.getInstance().registEvent(y.HUNT_FINISH,this,this.onDoWorkFinish);let e=this.hurtAnimal.getComponent(D);e.joinHunt(this.model.getResidentId()),e.pauseWalk();let t=n.randomPointForX(this.hurtAnimal.x,this.hurtAnimal.y+this.hurtAnimal.height,this.hurtAnimal.width);this.walkTo({x:t.x-this.owner.width/2,y:t.y-this.owner.height/2},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.Hunting)}))}startJoinTalkingPoint(e){let t=e.getTalkingPosInArea();this.walkTo({x:t.x,y:t.y},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.TalkingAbout,e)}))}startJoinFightPoint(e){let t=e.getFightPosInArea();this.walkTo({x:t.x,y:t.y},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.Fighting,e)}))}startMakelove(){if(1==this.model.getSex()){b.getInstance().getBuildingById(this.model.getMyHomeId()).buildingScript.startMakeLove(Laya.Handler.create(this,function(){let e=this.model.getLoverId(),t=this.residentMgrInstance.getResidentById(e);t.y+=r.ResidentGotoYOff,this.owner.y+=r.ResidentGotoYOff,t.residentLogicScript.refreshFSMState(r.ResidentState.IdleState),this.refreshFSMState(r.ResidentState.IdleState),this.residentMgrInstance.createResidentByConfig({parent:i.mapContainer,x:t.x,y:t.y,age:1,sex:P.getInstance().randomSex(),food:70,water:70})}))}this.model.recordMakeLoveSystemTime()}startFindWoman(){let e=this.model.getLoverId(),t=this.residentMgrInstance.getResidentById(e);t?this.walkTo({x:t.x+t.width,y:t.y},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.LoverGoHomeMakeLove),t.residentLogicScript.refreshFSMState(r.ResidentState.LoverGoHomeMakeLove)})):this.refreshFSMState(r.ResidentState.IdleState)}startGoHomeAndWoman(){let e=b.getInstance().getBuildingById(this.model.getMyHomeId());e?this.walkTo({x:e.x+e.width/2-this.owner.width/2,y:e.y+e.height-this.owner.height+r.ResidentGotoYOff,forceFirstY:!0},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.LoverMakeLove)})):this.refreshFSMState(r.ResidentState.IdleState)}walkTo(e,t){if(this.getMoveScript().gotoDest(e,t),this.getPet()){let t={x:e.x+60,y:e.y-40,speed:120,forceFirstY:e.isFirstY,tag:1};Laya.timer.once(1e3,this,function(){this.getPetScript().walkTo(t)})}}startFindCreateHomeBlock(){if(this.findCreateHomeTimes<r.ResidentFindPathTimes){if(this.model.getFSMState()==r.ResidentState.FindBlockForCreateHome){let t=n.randomByArea2(this.owner.x,this.owner.y,300,i.mapWidth,i.mapHeight,h.MapSideOff,h.MapSideOff);this.walkTo({x:t.x,y:t.y},Laya.Handler.create(this,function(){this.findCreateHomeTimes++;let t=a.BuildingDatas[String(a.BuildingType.HomeType)],s=this.owner.x-t.width/2+this.owner.width/2,n=this.owner.y-t.height+this.owner.height;if(O.isOccupySpace(s,n,t.width,t.height))this.startFindCreateHomeBlock();else{let t=b.getInstance().createBuildingByConfig({parent:i.mapContainer,x:s,y:n,prefab:e.HomePrefabPath,buildingType:a.BuildingType.HomeType});this.model.setMyHomeId(t.buildingScript.getModel().getBuildingId()),this.refreshFSMState(r.ResidentState.GotoContinueCreateHome,t)}}))}}else this.refreshFSMState(r.ResidentState.IdleState),this.findCreateHomeTimes=0}startFindANearstTree(){let e=B.getInstance().getNearstTree(this.owner.x,this.owner.y);e?this.walkTo({x:e.x+e.width/2-this.owner.width/2,y:e.y+e.height-this.owner.height+20},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.CutDownTree)})):this.refreshFSMState(r.ResidentState.IdleState)}startFindANearstWater(){let e=k.getInstance().randomWater(this.owner.x,this.owner.y,2e3);if(e){let t=n.randomPointInRect(e.x,e.y,e.width,e.height);this.walkTo({x:t.x,y:t.y},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.DrinkWater)}))}else this.refreshFSMState(r.ResidentState.IdleState)}startFindANearstFood(){let e=M.getInstance().getNearstFood({x:this.owner.x,y:this.owner.y,state:c.FoodState.CanEat,area:2e3});if(e){e.foodScript.getModel().setFoodState(c.FoodState.Occupy),this.walkTo({x:e.x,y:e.y},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.EatFood,e)}))}else this.refreshFSMState(r.ResidentState.IdleState)}startFindANearstStone(){let e=A.getInstance().getNearstStone(this.owner.x,this.owner.y);if(e){let t=n.randomPointInRect(e.x,e.y,e.width,e.height);this.walkTo({x:t.x,y:e.y+e.height},Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.CollectStone)}))}else this.refreshFSMState(r.ResidentState.IdleState)}makeParam(e){let t={};return t.residentIds=new Set([this.model.getResidentId()]),t.extraParam=e,t}processResult(){this.level1Results=[],this.level2Results=[],this.processDrinkWater(),this.processEatFood(),this.processSocial(),this.processCutDownTree(),this.processCollectStone(),this.processHunt(),this.processCreateHome(),this.processLookForLover(),this.processFight(),this.processRandomWalk(),this.processCreateBuilding(),this.processSend(),this.processUseBuildingAI()}doResult(){for(;0!=this.level1Results.length;){let e=n.randomNumber(0,this.level1Results.length-1),t=this.level1Results[e];if(this.ideaResult=!1,t.func.runWith(t.param),this.ideaResult)return;this.level1Results.splice(e,1)}for(;0!=this.level2Results.length;){let e=n.randomNumber(0,this.level2Results.length-1),t=this.level2Results[e];if(this.ideaResult=!1,t.func.runWith(t.param),this.ideaResult)return;this.level2Results.splice(e,1)}this.ideaResult=!1}makeIdea(){this.model.getFSMState()==r.ResidentState.IdleState&&n.randomYes(this.model.getPositive())&&(n.randomYes(E.BoredTipsProbability)&&this.showTip(E.randomOneBoredTip()),this.processResult(),this.doResult())}processEatFood(){let e={func:Laya.Handler.create(this,function(){M.getInstance().canFindFood()&&(this.refreshFSMState(r.ResidentState.FindFood),this.ideaResult=!0)})},t=this.model.getFood();t<r.ResidentFoodNeedValue?this.level1Results.push(e):t<90&&this.level2Results.push(e)}processDrinkWater(){let e={func:Laya.Handler.create(this,function(){this.refreshFSMState(r.ResidentState.FindWater),this.ideaResult=!0})},t=this.model.getWater();t<r.ResidentWaterNeedValue?this.level1Results.push(e):t<100&&this.level2Results.push(e)}processSocial(){let e={func:Laya.Handler.create(this,function(e){let t=this.residentMgrInstance.getACanSocialResident(this.owner);if(t){let e=P.getInstance().getOrCreateTalkingPoint(this.owner.x,this.owner.y,40,5);0==e.getTalkingNum()?(e.addTalkingNum(2),this.refreshFSMState(r.ResidentState.JoinTalking,e),t.getComponent(U).refreshFSMState(r.ResidentState.JoinTalking,e)):(e.addTalkingNum(1),this.refreshFSMState(r.ResidentState.JoinTalking,e)),this.ideaResult=!0}})},t=this.model.getSocial();t<r.ResidentSocialNeedValue?this.level1Results.push(e):n.randomYes()&&t<100&&this.level2Results.push(e)}processCutDownTree(){let e={func:Laya.Handler.create(this,function(e){this.refreshFSMState(r.ResidentState.FindTree),this.ideaResult=!0})};n.randomYes()&&this.model.getAge()>=r.ResidentAdultAge&&this.level2Results.push(e)}processCollectStone(){let e={func:Laya.Handler.create(this,function(e){this.refreshFSMState(r.ResidentState.FindStone),this.ideaResult=!0})};n.randomYes()&&this.model.getAge()>=r.ResidentAdultAge&&this.level2Results.push(e)}processHunt(){let e={func:Laya.Handler.create(this,function(e){let t=v.getInstance().getAnimalForAttack(this.owner.x,this.owner.y,2e3);t&&(this.refreshFSMState(r.ResidentState.JoinHunt,t),this.ideaResult=!0)})};n.randomYes()&&this.model.getAge()>=r.ResidentAdultAge&&this.level2Results.push(e)}processCreateHome(){if(n.randomYes()&&0==this.model.getMyHomeId()&&1==this.model.getSex()&&this.model.getAge()>=r.ResidentAdultAge&&b.getInstance().canCreateBuildingForResource(a.BuildingType.HomeType)){let e={func:Laya.Handler.create(this,function(e){this.refreshFSMState(r.ResidentState.FindBlockForCreateHome),this.ideaResult=!0})};this.level1Results.push(e)}}processLookForLover(){if(n.randomYes(.2)&&this.model.canAskMarry()){let e=b.getInstance().getBuildingById(this.model.getMyHomeId());if(e){let t=e.buildingScript.getModel(),i=P.getInstance().getAllResidentNum(),s=P.getInstance().getHomeNum()*r.ResidentNumPerHome;if(t.getBuildingState()==a.BuildingState.Noraml&&i<=s){let e={func:Laya.Handler.create(this,function(e){let t=this.residentMgrInstance.getCanMarryWoman(this.model);if(t){let e=t.residentLogicScript,i=e.getModel();P.getInstance().setMarried(this.model,i),this.refreshFSMState(r.ResidentState.LoverMan),e.refreshFSMState(r.ResidentState.LoverWoman),this.ideaResult=!0}})};this.level1Results.push(e)}}}}processFight(){let e={func:Laya.Handler.create(this,function(e){let t=this.residentMgrInstance.getACanFightResident(this.model,this.owner.x,this.owner.y);if(t){let e=P.getInstance().getOrCreateFightPoint(this.owner.x,this.owner.y,30,5);0==e.getFightNum()?(e.addFightNum(2),this.refreshFSMState(r.ResidentState.JoinFight,e),t.residentLogicScript.refreshFSMState(r.ResidentState.JoinFight,e)):(e.addFightNum(1),this.refreshFSMState(r.ResidentState.JoinFight,e)),this.ideaResult=!0}})};this.model.getSocial()<r.ResidentSocialLowToFight&&P.getInstance().getAllResidentNum()>=r.ResidentFightNum&&this.level2Results.push(e)}processRandomWalk(){let e={func:Laya.Handler.create(this,function(){let e=n.randomByArea(this.owner.x,this.owner.y,200);O.isOccupySpace(this.owner.x,this.owner.y,this.owner.width,this.owner.height)||(this.refreshFSMState(r.ResidentState.RandomWalk,e),this.ideaResult=!0)})};this.level2Results.push(e)}processCreateBuilding(){if(this.model.getAge()>=r.ResidentAdultAge){let e={func:Laya.Handler.create(this,function(){let e=O.getAIGoToCreateBuildingInfo(this.owner.x,this.owner.y);e&&(this.refreshFSMState(e.state,e.building),this.ideaResult=!0)})};this.level2Results.push(e)}}processSend(){for(const e in r.ResidentSendAIMap)if(this.canSend(e)){let t={func:Laya.Handler.create(this,function(){let t=this.getSendAndDest(e);t&&t.send&&t.dest&&(this.preSend(e,t),this.refreshFSMState(e,t),this.ideaResult=!0)})};this.level2Results.push(t)}}canSendExt(e){return r.ResidentSendAIMap[e]}gotoFindSend(e){let t=e.sendAIMeta,i=e.sendInfo;this.setAnim(r.ResidentAnim.Walk);let s=t.collectState;this.walkTo({x:i.send.x+i.send.width/2-this.owner.width/2,y:i.send.y+i.send.height-this.owner.height+r.ResidentGotoYOff},Laya.Handler.create(this,function(){this.refreshFSMState(s,e)}))}canCollect(e){for(const t in r.ResidentSendAIMap){if(e==r.ResidentSendAIMap[t].collectState&&null!=e&&null!=e)return!0}return!1}canSendToDest(e){for(const t in r.ResidentSendAIMap){if(e==r.ResidentSendAIMap[t].lastState&&null!=e&&null!=e)return!0}return!1}canSendFinish(e){for(const t in r.ResidentSendAIMap){if(e==r.ResidentSendAIMap[t].lastState&&null!=e&&null!=e)return!0}return!1}colletSend(e){this.setAnim(r.ResidentAnim.Work),this.setStateAniVisible(!0),this.setStateAni("ani9"),Laya.timer.once(r.ResidentCollectSendTime,this,this.onCollectSendFinish,[e])}onCollectSendFinish(e){let t=e.sendAIMeta;this.onGetAddValueInfo(e),this.refreshFSMState(t.lastState,e)}gotoSendToDest(e){this.setStateAniVisible(!0),this.setStateAni("ani10");let t=e.sendInfo;this.walkTo({x:t.dest.x+t.dest.width/2-this.owner.width/2,y:t.dest.y+t.dest.height-this.owner.height+r.ResidentGotoYOff},Laya.Handler.create(this,function(){this.onPutDownSend(e)}))}onPutDownSend(e){this.owner.visible=!1,Laya.timer.once(1e3,this,function(){this.owner.visible=!0,this.onDoWorkFinish(this.makeParam(e))})}onGetAddValueInfo(e){let t=e.sendInfo,i=this.model.getFSMState();if(i==r.ResidentState.CollectFood){let i=t.send.foodScript.getModel(),s=i.getFood();M.getInstance().removeFoodById(i.getFoodId()),t.send=null,e.addFood=s}else i==r.ResidentState.CollectWater&&(e.addWater=r.ResidentSaveWaterAddValue)}onFinishSend(e){let t=e.extraParam,i=t.sendInfo.dest,s=this.model.getFSMState();s==r.ResidentState.SendFoodToFoodPool?i.buildingScript.addFoodToPool(t.addFood):s==r.ResidentState.SendWaterToWaterPool&&i.buildingScript.addWaterToPool(t.addWater)}canSend(e){return e==r.ResidentState.FindFoodForSend?!(this.model.getAge()<r.ResidentAdultAge):e==r.ResidentState.FindWaterForSend?!(this.model.getAge()<r.ResidentAdultAge):void 0}getSendAndDest(e){if(e==r.ResidentState.FindFoodForSend){let t=M.getInstance().getNearstFood({x:this.owner.x,y:this.owner.y,state:c.FoodState.CanEat,area:2e3}),i=b.getInstance().getNearstBuilding(this.owner.x,this.owner.y,a.BuildingType.FoodPoolType,2e3,[a.BuildingState.Noraml]);return i&&!i.buildingScript.isReachFoodMax()?{AIType:e,send:t,dest:i}:null}if(e==r.ResidentState.FindWaterForSend){return{AIType:e,send:k.getInstance().randomWater(this.owner.x,this.owner.y,2e3),dest:b.getInstance().getNearstBuilding(this.owner.x,this.owner.y,a.BuildingType.WaterPoolType,2e3,[a.BuildingState.Noraml])}}}preSend(e,t){e==r.ResidentState.FindFoodForSend&&t.send.foodScript.getModel().setFoodState(c.FoodState.Occupy)}processUseBuildingAI(){for(const e in r.ResidentUseBuildingMap){let t=r.ResidentUseBuildingMap[e];if(this.useBuildingAIPriority=2,this.onUseBuildingCondition(e)){let i={func:Laya.Handler.create(this,function(){let i=this.onGetBuilding(e,t);i&&(this.refreshFSMState(e,i),this.ideaResult=!0)})};2==this.useBuildingAIPriority?this.level2Results.push(i):this.level1Results.push(i)}}}addPetByPetType(t){let i=Laya.loader.getRes(e.PetPrefabPath).create();i.petScript=i.getComponent(j),this.pet=i,this.owner.parent.addChild(this.pet),this.pet.x=this.owner.x+this.owner.width,this.pet.y=this.owner.y+20}getPet(){return this.pet}getPetScript(){return this.getPet().petScript}}class V extends Laya.Script{constructor(){super(),this.residents={}}onEnable(){}onDisable(){}static getInstance(){return V.instance?V.instance:(V.instance=new V,V.instance.initSelf(),V.instance)}initSelf(){Laya.timer.loop(r.ResidentMakeIdeaStep,this,this.onMakeIdea),Laya.timer.loop(100,this,this.onUpdateZorder)}onUpdateZorder(){for(let e in this.residents){let t=this.residents[e];t.residentLogicScript.pet&&s.setMapZOrder(t.residentLogicScript.pet),s.setMapZOrder(t)}}onMakeIdea(){for(let e in this.residents){let t=this.residents[e];s.setMapZOrder(t),t.residentLogicScript.makeIdea()}}getResidentById(e){return this.residents[String(e)]}createResidentByConfig(t){let i=Laya.loader.getRes(e.ResidentPrefabPath).create();t.parent.addChild(i);let s=i.getComponent(U);i.residentLogicScript=s;let n=i.getComponent(o);i.residentMoveLogicScript=n;let a=P.getInstance().newResidentModel(t);return s.refreshByModel(a),s.setResidentMgrInstance(this),this.residents[String(a.getResidentId())]=i,i}removeResidentById(e){let t=this.residents[String(e)];if(t){let i=t.residentLogicScript.getModel(),s=t.residentLogicScript.getPet();s&&s.destroy(!0);for(const t in this.residents){let s=this.residents[t].residentLogicScript.getModel();s.getLoverId()==e&&s.setLoverId(0),1==i.getSex()&&s.getMyHomeId()==i.getMyHomeId()&&s.setMyHomeId(0)}delete this.residents[String(e)],t.destroy(!0),P.getInstance().removeResientModel(e)}}getACanSocialResident(e){let t=e.x,i=e.y,s=[],n=[];for(const a in this.residents){let o=this.residents[a],h=o.residentLogicScript.getModel(),d=new Laya.Point(t,i).distance(o.x,o.y);e!=o&&d<=r.ResidentSocialArea&&h.getFSMState()==r.ResidentState.IdleState&&(s.push(o),h.getSocial()<r.ResidentSocialNeedValue&&n.push(o))}return 0!=n.length?n[0]:0!=s.length?s[0]:null}getACanFightResident(e,t,i){let s=[],n=[];for(const a in this.residents){let o=this.residents[a],h=o.residentLogicScript.getModel(),d=new Laya.Point(t,i).distance(o.x,o.y);e.getResidentId()!=h.getResidentId()&&d<=r.ResidentFightArea&&h.getFSMState()==r.ResidentState.IdleState&&(s.push(o),h.getSocial()<r.ResidentSocialLowToFight&&n.push(o))}return 0!=n.length?n[0]:0!=s.length?s[0]:null}getCanMarryWoman(e){for(const t in this.residents){let i=this.residents[t];if(i.residentLogicScript.getModel().canMarry(e))return i}return null}}class _ extends Laya.Script{constructor(){super()}onEnable(){this.ScrollView=this.owner.getChildByName("ScrollView"),this.container=this.ScrollView.getChildByName("container"),V.getInstance().createResidentByConfig({parent:this.container,x:this.container.width/2-300,y:this.container.height/2,sex:2,age:29}),V.getInstance().createResidentByConfig({parent:this.container,x:this.container.width/2-200,y:this.container.height/2,sex:1,age:28})}onDisable(){}}class Y extends Laya.Script{constructor(){super()}onEnable(){s.setMapZOrder(this.owner,-i.mapHeight),this.curBg=this.owner.getChildByName("curBg"),this.toBg=this.owner.getChildByName("toBg"),this.curSeason=P.getInstance().getGameSeason(),this.switchSeason(this.curSeason,!0),Laya.timer.loop(1e3,this,this.onTimeTick)}onDisable(){Laya.timer.clear(this,this.onTimeTick)}onTimeTick(){this.curSeason!=P.getInstance().getGameSeason()&&(this.curSeason=P.getInstance().getGameSeason(),this.switchSeason(this.curSeason))}switchSeason(e,t){this.tweenObject&&(Laya.Tween.clear(this.tweenObject),this.tweenObject=null);let i=h.Seasons[e];if(t)this.toBg.visible=!1,this.curBg.bgColor=i;else{this.toBg.visible=!0,this.toBg.bgColor=this.curBg.bgColor,this.curBg.bgColor=i,this.toBg.alpha=1,this.curBg.alpha=0;let e=4e3;this.tweenObject=Laya.Tween.to(this.curBg,{alpha:1},e,null,Laya.Handler.create(this,function(){this.tweenObject&&(Laya.Tween.clear(this.tweenObject),this.tweenObject=null),this.toBg.visible=!1}))}}}class X extends Laya.Script{constructor(){super()}onEnable(){this.curNum=0}onDisable(){}onStart(){this.owner.timer.loop(d.AnimalUpdateTime,this,function(){if(this.curNum>=d.AnimalMaxNumPerTrigger)return;let e=n.randomByArea(this.owner.x,this.owner.y,d.AnimalTriggerArea);v.getInstance().createAnimalByConfig({parent:i.mapContainer,x:e.x,y:e.y,trigger:this}),this.addNum(1)})}addNum(e){this.curNum=this.curNum+e,this.curNum>=d.AnimalMaxNumPerTrigger&&(this.curNum=d.AnimalMaxNumPerTrigger)}}class J extends Laya.Script{constructor(){super()}onEnable(){this.startPos=null,this.container=this.owner.getChildByName("container"),i.mapContainer=this.container,i.mapWidth=this.container.width,i.mapHeight=this.container.height}onDisable(){}onStart(){for(let e=0;e<this.container.numChildren;e++){let t=this.container.getChildAt(e);t.getComponent(I)&&B.getInstance().pushTree(t),t.getComponent(C)&&A.getInstance().pushStone(t),t.getComponent(N)&&k.getInstance().pushWater(t),t.getComponent(H)&&W.getInstance().pushFoodTrigger(t)}this.lookAt(i.mapWidth/2,i.mapHeight/2)}onMouseDown(e){this.startPos={x:e.stageX,y:e.stageY}}onMouseMove(e){if(this.startPos){let t=e.stageX-this.startPos.x,i=e.stageY-this.startPos.y;this.processMapPos(this.container.x+t,this.container.y+i),this.startPos.x=e.stageX,this.startPos.y=e.stageY}}onMouseUp(e){this.startPos=null}onMouseOut(e){this.startPos=null}processMapPos(e,t){let i=this.getMapPos(e,t);this.container.x=i.x,this.container.y=i.y}getMapPos(e,t){return e>-h.MapSideOff&&(e=-h.MapSideOff),t>-h.MapSideOff&&(t=-h.MapSideOff),e<this.owner.width-i.mapWidth+h.MapSideOff&&(e=this.owner.width-i.mapWidth+h.MapSideOff),t<this.owner.height-i.mapHeight+h.MapSideOff&&(t=this.owner.height-i.mapHeight+h.MapSideOff),{x:e,y:t}}lookAt(e,t,i){null!=i&&null!=i||(i=!1),this.tweenObject&&(Laya.Tween.clear(this.tweenObject),this.tweenObject=null);let s=new Laya.Point(e,t);this.container.localToGlobal(s);let n=Laya.stage.width/2,a=Laya.stage.height/2,r=n-s.x,o=a-s.y,h=this.container.x+r,d=this.container.y+o;if(i){let e=this.getMapPos(h,d);this.tweenObject=Laya.Tween.to(this.container,{x:e.x,y:e.y},1e3,Laya.Ease.sineOut,Laya.Handler.create(this,function(){this.tweenObject&&(Laya.Tween.clear(this.tweenObject),this.tweenObject=null)}))}else this.processMapPos(h,d)}}class Z extends Laya.Script{constructor(){super()}onEnable(){this.treeLabel=this.owner.getChildByName("tree"),this.stoneLabel=this.owner.getChildByName("stone"),this.timeLabel=this.owner.getChildByName("time"),this.seasonTextTable=["春","夏","秋","冬"],this.refreshLabel(),Laya.timer.loop(h.GameTimeStep,this,this.onTick)}onDisable(){Laya.timer.clear(this,this.onTick)}refreshLabel(){this.treeLabel.text=String(P.getInstance().getTreeNum()),this.stoneLabel.text=String(P.getInstance().getStoneNum());let e=P.getInstance().getGameSeason(),t=P.getInstance().getGameDay(),i=P.getInstance().getGameHour();this.timeLabel.text=String(this.seasonTextTable[e])+"  "+String(t.zeroPad(10))+"日"+String(i.zeroPad(10))+"时"}onTick(){this.refreshLabel()}}class K extends Laya.Script{constructor(){super()}onEnable(){let e=this.owner.getChildByName("image");this.textLabel=e.getChildByName("label"),e.x=-e.width/2}onDisable(){}setString(e){this.textLabel.text=e,this.owner.x=Laya.stage.width/2,this.owner.y=Laya.stage.height/2,Laya.Tween.to(this.owner,{y:this.owner.y-70},300,Laya.Ease.linearOut,Laya.Handler.create(this,function(){Laya.timer.once(1e3,this,function(){Laya.Tween.to(this.owner,{alpha:0},500,Laya.Ease.linearOut,Laya.Handler.create(this,function(){this.owner.destroy(!0)}))})}))}}class z extends Laya.Script{constructor(){super()}onEnable(){}onDisable(){}static getInstance(){return z.instance=z.instance||new z}showTip(t,i){let s=Laya.loader.getRes(e.TipPrefabPath).create();Laya.stage.addChild(s),s.getComponent(K).setString(t)}}class Q extends Laya.Script{constructor(){super()}onEnable(){this.switchState=0,this.initBg(),this.initTOuchLayer(),this.setTouchLayerEnabled(!1),this.initItems(),this.initScrollTouch(),Laya.timer.loop(300,this,this.refreshCondition),this.refreshCondition()}onDisable(){Laya.timer.clear(this,this.refreshCondition)}refreshCondition(){for(const e in this.items){let t=this.items[e],i=t.showData,s=P.getInstance().getTreeNum(),n=P.getInstance().getStoneNum(),a=!1;t.treeNeed.color="#1497ef",t.stoneNeed.color="#1497ef",s<i.costTree&&(a=!0,t.treeNeed.color="#ef1437"),n<i.costStone&&(a=!0,t.stoneNeed.color="#ef1437"),t.lock.visible=a}}initItems(){this.dataArray=[],this.items={};for(const e in a.BuildingDatas){let t=a.BuildingDatas[e];t.type!=a.BuildingType.HomeType&&this.dataArray.push(t)}this.clip=this.under.getChildByName("clip"),this.content=this.clip.getChildByName("content");this.dragRender=Laya.loader.getRes(e.DragRenderPrefabPath).create();let t=Laya.loader.getRes(e.CommonItemPrefabPath),i=0;for(let e=0;e<this.dataArray.length;e++){let s=this.dataArray[e],n=t.create();0==e&&(i=n.height),n.getChildByName("spr").loadImage(s.preview),n.getChildByName("textName").text="["+s.buildingName+"]";let a=n.getChildByName("treeNeed");a.text="木材:"+String(s.costTree);let r=n.getChildByName("stoneNeed");r.text="石材:"+String(s.costStone),n.getChildByName("desc").text=s.desc;let o=n.getChildByName("lock");n.lock=o,n.treeNeed=a,n.stoneNeed=r,this.content.addChild(n),n.y=e*i+5*(e+1),n.showIndex=e,n.showData=s,this.items[String(e)]=n}this.content.height=i*this.dataArray.length+5*this.dataArray.length}getItem(e,t){for(const i in this.items){let s=this.items[i];if(s.hitTestPoint(e,t))return s}return null}initScrollTouch(){this.touchScroll=this.clip.getChildByName("touchScroll"),this.touchDownPoint=null,this.touchScroll.on(Laya.Event.MOUSE_DOWN,this,function(e){this.dragItem=null,this.touchDownStartPoint=new Laya.Point(e.stageX,e.stageY),this.touchDownPoint=new Laya.Point(e.stageX,e.stageY);let t=this.getItem(e.stageX,e.stageY);t&&Laya.timer.once(200,this,this.onDragStart,[t])}),this.touchScroll.on(Laya.Event.MOUSE_MOVE,this,function(e){if(this.touchDownPoint&&(null==this.dragItem||null==this.dragItem)){Math.abs(this.touchDownStartPoint.y-e.stageY)>=5&&Laya.timer.clear(this,this.onDragStart);let t=e.stageY-this.touchDownPoint.y;this.content.y=this.content.y+t;let i=this.clip.height-this.content.height;this.content.y<i?this.content.y=i:this.content.y>0&&(this.content.y=0),this.touchDownPoint.setTo(e.stageX,e.stageY)}}),this.touchScroll.on(Laya.Event.MOUSE_OUT,this,function(e){this.touchDownPoint=null,Laya.timer.clear(this,this.onDragStart),this.touchDownStartPoint=null}),this.touchScroll.on(Laya.Event.MOUSE_UP,this,function(e){this.touchDownPoint=null,this.touchDownStartPoint=null,Laya.timer.clear(this,this.onDragStart)})}onDragStart(t){if(Laya.timer.clear(this,this.onDragStart),t.lock.visible)z.getInstance().showTip("建造条件不足");else if(this.dragItem=t,this.setTouchLayerEnabled(!0),this.dragItem){let t=this.dragItem.showData;this.dragRender&&(this.dragRender.destroy(!0),this.dragRender=null);let i=Laya.loader.getRes(e.DragRenderPrefabPath);this.dragRender=i.create(),this.dragRender.width=t.width,this.dragRender.height=t.height,this.dragRender.dragMask=this.dragRender.getChildByName("dragMask"),this.dragRender.dragMask.width=t.width,this.dragRender.dragMask.height=t.height,this.dragRender.dragMask2=this.dragRender.getChildByName("dragMask2"),this.dragRender.dragMask2.width=t.width,this.dragRender.dragMask2.height=t.height,this.setBuildingCreateEnabled(!0),this.touchLayer.addChild(this.dragRender);let s=new Laya.Sprite;s.loadImage(t.preview),this.dragRender.addChild(s),s.pos(t.adjustX,t.adjustY);let n=new Laya.Point(Laya.stage.mouseX,Laya.stage.mouseY);this.touchLayer.globalToLocal(n);let a=n.x-this.dragRender.width/2,r=n.y-this.dragRender.height/2;this.dragRender.pos(a,r),this.under.visible=!1}}initTOuchLayer(){this.touchLayer=this.owner.getChildByName("touch"),this.touchLayerOriWidth=this.touchLayer.width}onTouchLayerMouseMove(e){if(this.dragRender){let t=new Laya.Point(e.stageX,e.stageY);this.touchLayer.globalToLocal(t);let s=t.x-this.dragRender.width/2,n=t.y-this.dragRender.height/2;this.dragRender.pos(s,n),i.mapContainer&&(t=new Laya.Point(e.stageX,e.stageY),i.mapContainer.globalToLocal(t),s=t.x-this.dragRender.width/2,n=t.y-this.dragRender.height/2,O.isOccupySpace(s,n,this.dragRender.width,this.dragRender.height)?this.setBuildingCreateEnabled(!1):this.setBuildingCreateEnabled(!0))}}onTouchLayerMouseUp(e){if(i.mapContainer){let t=new Laya.Point(e.stageX,e.stageY);i.mapContainer.globalToLocal(t);let s=t.x-this.dragRender.width/2,n=t.y-this.dragRender.height/2,a=this.dragItem.showData;O.isOccupySpace(s,n,this.dragRender.width,this.dragRender.height)?z.getInstance().showTip("不可放置~"):this.onBuild(a,s,n)}this.dragItem&&(this.dragItem=null),this.dragRender&&this.dragRender.destroy(!0),this.setTouchLayerEnabled(!1),this.under.visible=!0}onTouchLayerMouseOut(e){this.dragItem&&(this.dragItem=null),this.dragRender&&this.dragRender.destroy(!0),this.setTouchLayerEnabled(!1),this.under.visible=!0}setTouchLayerEnabled(e){e?(this.touchLayer.width=this.touchLayerOriWidth,this.touchLayer.on(Laya.Event.MOUSE_MOVE,this,this.onTouchLayerMouseMove),this.touchLayer.on(Laya.Event.MOUSE_UP,this,this.onTouchLayerMouseUp),this.touchLayer.on(Laya.Event.MOUSE_OUT,this,this.onTouchLayerMouseOut)):(this.touchLayer.width=0,this.touchLayer.off(Laya.Event.MOUSE_MOVE,this,this.onTouchLayerMouseMove),this.touchLayer.off(Laya.Event.MOUSE_UP,this,this.onTouchLayerMouseUp),this.touchLayer.off(Laya.Event.MOUSE_OUT,this,this.onTouchLayerMouseOut))}setBuildingCreateEnabled(e){this.dragRender&&(this.dragRender.dragMask.visible=e,this.dragRender.dragMask2.visible=!e)}setUnderState(e){this.switchState!=e&&(this.switchState=e,0==this.switchState?(Laya.Tween.to(this.under,{x:-this.under.width},200,Laya.Ease.backOut),this.switchBtn.scaleX=1):(Laya.Tween.to(this.under,{x:0},200,Laya.Ease.backIn),this.switchBtn.scaleX=-1))}initBg(){this.under=this.owner.getChildByName("under"),this.under.x=-this.under.width,this.oriOwerWidth=this.owner.width,this.owner.width=0,this.switchBtn=this.under.getChildByName("btn"),this.switchBtn.on(Laya.Event.CLICK,this,function(){1==this.switchState?(this.setUnderState(0),this.owner.width=0):(this.setUnderState(1),this.owner.width=this.oriOwerWidth)})}onBuild(e,t,s){P.getInstance().addTreeNum(-a.BuildingDatas[String(e.type)].costTree),P.getInstance().addStoneNum(-a.BuildingDatas[String(e.type)].costStone);b.getInstance().createBuildingByConfig({parent:i.mapContainer,x:Math.round(t),y:Math.round(s),width:e.width,height:e.height,prefab:e.prefab,buildingType:e.type})}}class q extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class $ extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class ee extends F{constructor(){super()}onEnable(){super.onEnable(),this.foodPoolText=this.owner.getChildByName("foodPoolText"),this.foodPoolText.visible=!1,this.maxSave=a.BuildingDatas[a.BuildingType.FoodPoolType].maxSave}getCurSaveFood(){let e=this.getModel().getExteraData("curFood");return null!=e&&null!=e||(e=0),e}isReachFoodMax(){return this.getCurSaveFood()>=this.maxSave}addFoodToPool(e){let t=this.getModel(),i=this.getCurSaveFood();(i+=e)<0&&(i=0),i>this.maxSave&&(i=this.maxSave),t.setExteraData("curFood",i),this.foodPoolText.text=String(i)+"/"+String(this.maxSave)}onInitBuilding(){this.addFoodToPool(0)}onCreateBuildingFinish(){this.foodPoolText.visible=!0}}class te extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}onDisable(){Laya.timer.clear(this,this.onMakeLove),Laya.timer.clear(this,this.onCreateProgress)}startMakeLove(e){this.makeLoveHandler=e,this.ani.play(0,!0,"makelove"),Laya.timer.once(5e3,this,this.onMakeLove)}onMakeLove(){this.makeLoveHandler&&(this.makeLoveHandler.run(),this.makeLoveHandler=null,this.ani.play(0,!0,"idle"),Laya.timer.clear(this,this.onMakeLove))}}class ie extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class se extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class ne extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class ae extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class re extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class oe extends F{constructor(){super()}onEnable(){super.onEnable(),this.petList=[1,2,3]}obtainPetList(){let e=this.getModel().getExteraData("petList");if(null!=e&&null!=e||(e=""),""!=e){let t=e.split(",");for(const e in t)this.petList.push(Number(t[e]))}}getFirstPetInPetList(){if(0!=this.petList.length){return this.petList[0]}return null}popFirstPet(){let e=this.getFirstPetInPetList();return e?(this.petList.splice(0,1),this.getModel().setExteraData("petList",this.petList.toString()),e):null}onInitBuilding(){this.obtainPetList()}onCreateBuildingFinish(){}}class he extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class de extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class le extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class ue extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class ge extends F{constructor(){super()}onInitBuilding(){}onCreateBuildingFinish(){}}class ce extends F{constructor(){super()}onEnable(){super.onEnable(),this.waterPoolText=this.owner.getChildByName("waterPoolText"),this.waterPoolText.visible=!1,this.maxSave=a.BuildingDatas[a.BuildingType.WaterPoolType].maxSave}getCurSaveWater(){let e=this.getModel().getExteraData("curWater");return null!=e&&null!=e||(e=0),e}isReachWaterMax(){return this.getCurSaveWater()>=this.maxSave}addWaterToPool(e){let t=this.getModel(),i=this.getCurSaveWater();(i+=e)<0&&(i=0),i>this.maxSave&&(i=this.maxSave),t.setExteraData("curWater",i),this.waterPoolText.text=String(i)+"/"+String(this.maxSave)}onInitBuilding(){this.addWaterToPool(0)}onCreateBuildingFinish(){this.waterPoolText.visible=!0}}class Se{static init(){let e=Laya.ClassUtils.regClass;e("scene/TestSceneLogic.js",_),e("game/SeasonLogic.js",Y),e("source/Treelogic.js",I),e("source/FoodTrigger.js",H),e("source/StoneLogic.js",C),e("source/Waterlogic.js",N),e("animal/AnimalTrigger.js",X),e("helper/MapScrollView.js",J),e("panel/ResourcePanel.js",Z),e("panel/CommandPanel.js",Q),e("animal/AnimalLogic.js",D),e("building/ChildSchoolLogic.js",q),e("building/FarmLandLogic.js",$),e("source/FoodLogic.js",x),e("building/FoodPoolLogic.js",ee),e("building/HomeLogic.js",te),e("building/HospitalLogic.js",ie),e("building/LabLogic.js",se),e("building/OfficeLogic.js",ne),e("building/OperaLogic.js",ae),e("building/PastureLogic.js",re),e("animal/PetLogic.js",j),e("helper/MoveLogic.js",o),e("building/PetShopLogic.js",oe),e("building/PoliceStationLogic.js",he),e("building/PowerPlantLogic.js",de),e("resident/ResidentLogic.js",U),e("panel/ResidentDetailsPanel.js",L),e("building/RestaurantLogic.js",le),e("building/SchoolLogic.js",ue),e("building/ShopLogic.js",ge),e("helper/TipLogic.js",K),e("building/WaterPoolLogic.js",ce)}}Se.width=1336,Se.height=750,Se.scaleMode="fixedwidth",Se.screenMode="none",Se.alignV="top",Se.alignH="left",Se.startScene="scene/TestScene.scene",Se.sceneRoot="",Se.debug=!1,Se.stat=!1,Se.physicsDebug=!1,Se.exportSceneToJson=!0,Se.init();new class{constructor(){window.Laya3D?Laya3D.init(Se.width,Se.height):Laya.init(Se.width,Se.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=Se.scaleMode,Laya.stage.screenMode=Se.screenMode,Laya.stage.alignV=Se.alignV,Laya.stage.alignH=Se.alignH,Laya.stage.frameRate="slow",Laya.URL.exportSceneToJson=Se.exportSceneToJson,(Se.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),Se.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),Se.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){P.getInstance(),t.getInstance().loadAllRes(Laya.Handler.create(this,function(){this.initBuildDatas(),Se.startScene&&Laya.Scene.open(Se.startScene)}))}initBuildDatas(){for(const e in a.BuildingDatas){let i=a.BuildingDatas[e],s=t.getInstance().getPrefabInfo(i.prefab);i.width=s.json.props.width,i.height=s.json.props.height,i.adjustX=(i.width-i.realWidth)/2,i.adjustY=i.height-i.realHeight,i.type=e}}}}();